---
- name: Regenerate Containerd Configurations on All Nodes
  hosts: all
  become: true
  gather_facts: true

  vars:
    containerd_config_path: /etc/containerd/config.toml
    backup_existing: true
    set_systemd_cgroup: true
    use_minimal_config: false  # Set to true to use minimal config instead of default
    sandbox_image: "{{ containerd_sandbox_image | default('registry.k8s.io/pause:3.10') }}"

  tasks:
    - name: Check if containerd is installed
      command: which containerd
      register: containerd_check
      changed_when: false
      failed_when: false

    - name: Fail if containerd is not installed
      fail:
        msg: "containerd is not installed or not in PATH"
      when: containerd_check.rc != 0

    - name: Check if containerd config file exists
      stat:
        path: "{{ containerd_config_path }}"
      register: containerd_config_stat

    - name: Backup existing config file
      copy:
        src: "{{ containerd_config_path }}"
        dest: "{{ containerd_config_path }}.bak.{{ ansible_date_time.epoch }}"
        remote_src: true
      when: backup_existing | default(true) and containerd_config_stat.stat.exists
      register: backup_result

    - name: Display backup information
      debug:
        msg: "Backed up existing config to {{ containerd_config_path }}.bak.{{ ansible_date_time.epoch }}"
      when: backup_existing | default(true) and containerd_config_stat.stat.exists and backup_result.changed

    - name: Generate default containerd config
      command: containerd config default
      register: default_config_output
      changed_when: true
      when: not use_minimal_config | default(false)

    - name: Write default config to file
      copy:
        content: "{{ default_config_output.stdout }}"
        dest: "{{ containerd_config_path }}"
        owner: root
        group: root
        mode: '0644'
      register: config_written
      when: not use_minimal_config | default(false)

    - name: Deploy minimal Kubernetes-ready config
      template:
        src: config-minimal.toml.j2
        dest: "{{ containerd_config_path }}"
        owner: root
        group: root
        mode: '0644'
      register: config_written
      when: use_minimal_config | default(false)

    - name: Verify config file was created
      stat:
        path: "{{ containerd_config_path }}"
      register: new_config_stat

    - name: Fail if config file was not created
      fail:
        msg: "Failed to create containerd config file"
      when: not new_config_stat.stat.exists

    - name: Set SystemdCgroup = true for Kubernetes compatibility
      replace:
        path: "{{ containerd_config_path }}"
        regexp: '(\[plugins\."io\.containerd\.grpc\.v1\.cri"\.containerd\.runtimes\.runc\.options\]\s+)(SystemdCgroup\s*=\s*)(false|true)'
        replace: '\1\2true'
      when: set_systemd_cgroup | default(true) and not use_minimal_config | default(false)
      register: systemd_cgroup_set

    - name: Ensure SystemdCgroup is set (add if missing)
      blockinfile:
        path: "{{ containerd_config_path }}"
        block: |
          SystemdCgroup = true
        insertafter: '\[plugins\."io\.containerd\.grpc\.v1\.cri"\.containerd\.runtimes\.runc\.options\]'
        marker: "# {mark} ANSIBLE MANAGED BLOCK - SystemdCgroup"
      when: set_systemd_cgroup | default(true) and not use_minimal_config | default(false) and systemd_cgroup_set.changed == false

    - name: Set sandbox image for Kubernetes
      lineinfile:
        path: "{{ containerd_config_path }}"
        line: '    sandbox_image = "{{ sandbox_image }}"'
        regexp: '^\s*sandbox_image\s*='
        insertafter: '\[plugins\."io\.containerd\.grpc\.v1\.cri"\]'
      register: sandbox_image_set
      when: not use_minimal_config | default(false)

    - name: Validate TOML syntax (try tomllib - Python 3.11+)
      command: python3 -c "import tomllib; tomllib.loads(open('{{ containerd_config_path }}', 'rb').read())"
      register: toml_validation_py311
      changed_when: false
      failed_when: false

    - name: Validate TOML syntax (fallback to toml library)
      command: python3 -c "import toml; toml.load('{{ containerd_config_path }}')"
      register: toml_validation_toml
      changed_when: false
      failed_when: false
      when: toml_validation_py311.rc != 0

    - name: Check if TOML validation libraries are available
      command: python3 -c "import sys; sys.exit(0 if ('tomllib' in sys.modules or 'toml' in sys.modules) else 1)"
      register: toml_lib_check
      changed_when: false
      failed_when: false

    - name: Display TOML validation result
      debug:
        msg:
          - "TOML syntax validation: {{ 'PASS' if (toml_validation_py311.rc == 0 or toml_validation_toml.rc == 0) else 'WARN - Could not validate (libraries may not be installed)' }}"
          - "Validation error (tomllib): {{ toml_validation_py311.stderr if toml_validation_py311.rc != 0 else 'N/A' }}"
          - "Validation error (toml): {{ toml_validation_toml.stderr if toml_validation_toml.rc != 0 and toml_validation_py311.rc != 0 else 'N/A' }}"
          - "Note: Containerd will validate the config when it starts. If it starts successfully, the config is valid."

    - name: Warn if TOML validation failed (non-fatal)
      debug:
        msg: "WARNING: TOML validation failed, but continuing. Containerd will validate the config on startup."
      when: toml_validation_py311.rc != 0 and toml_validation_toml.rc != 0

    - name: Restart containerd service
      systemd:
        name: containerd
        state: restarted
        enabled: true
      register: containerd_restart

    - name: Wait for containerd to be ready
      wait_for:
        path: /run/containerd/containerd.sock
        state: present
        timeout: 30
      when: containerd_restart.changed

    - name: Verify containerd is running
      systemd:
        name: containerd
      register: containerd_status

    - name: Display containerd status
      debug:
        msg:
          - "Containerd service status: {{ 'RUNNING' if containerd_status.status.ActiveState == 'active' else 'NOT RUNNING' }}"
          - "Config file: {{ containerd_config_path }}"
          - "Backup location: {{ containerd_config_path }}.bak.{{ ansible_date_time.epoch }} (if backup was created)"

    - name: Restart kubelet service (if kubelet is installed)
      systemd:
        name: kubelet
        state: restarted
      register: kubelet_restart
      failed_when: false
      changed_when: kubelet_restart.changed

    - name: Display kubelet restart status
      debug:
        msg: "Kubelet service: {{ 'RESTARTED' if kubelet_restart.changed else 'NOT RESTARTED (may not be installed or already running)' }}"
      when: kubelet_restart is defined

    - name: Display completion message
      debug:
        msg:
          - ""
          - "=== Containerd config regeneration completed ==="
          - "Host: {{ inventory_hostname }}"
          - "Config file: {{ containerd_config_path }}"
          - "Config type: {{ 'MINIMAL (Kubernetes-ready)' if use_minimal_config else 'DEFAULT (from containerd config default)' }}"
          - "SystemdCgroup: {{ 'SET' if set_systemd_cgroup else 'NOT SET' }}"
          - "Sandbox image: {{ sandbox_image }}"
          - "Containerd status: {{ 'RUNNING' if containerd_status.status.ActiveState == 'active' else 'CHECK MANUALLY' }}"
          - ""

