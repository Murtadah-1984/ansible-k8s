---
- name: Scan Containerd Configurations for Misconfigurations
  hosts: k8s_nodes
  become: true
  gather_facts: true

  vars:
    containerd_config_path: /etc/containerd/config.toml
    check_duplicates: true
    check_toml_syntax: true
    check_permissions: true

  tasks:
    - name: Check if containerd config file exists
      stat:
        path: "{{ containerd_config_path }}"
      register: containerd_config_stat
      failed_when: false

    - name: Display scan header
      debug:
        msg: "=== Scanning containerd config on {{ inventory_hostname }} ==="
      when: containerd_config_stat.stat.exists

    - name: Fail if containerd config file does not exist
      fail:
        msg: "Containerd config file not found at {{ containerd_config_path }}"
      when: not containerd_config_stat.stat.exists

    - name: Read containerd config file
      slurp:
        src: "{{ containerd_config_path }}"
      register: containerd_config_content
      when: containerd_config_stat.stat.exists

    - name: Check file permissions and ownership
      stat:
        path: "{{ containerd_config_path }}"
      register: containerd_config_perms
      when: check_permissions | default(true)

    - name: Report permission issues
      debug:
        msg:
          - "PERMISSION CHECK:"
          - "  Path: {{ containerd_config_path }}"
          - "  Mode: {{ '%04o' | format(containerd_config_perms.stat.mode | int) }}"
          - "  Owner: {{ containerd_config_perms.stat.pw_name }}"
          - "  Group: {{ containerd_config_perms.stat.gr_name }}"
          - "  Expected Mode: 0644"
          - "  Expected Owner: root"
          - "  Expected Group: root"
          - "  Status: {{ 'PASS' if (containerd_config_perms.stat.mode | int) == 33188 and containerd_config_perms.stat.pw_name == 'root' and containerd_config_perms.stat.gr_name == 'root' else 'FAIL' }}"
      when: check_permissions | default(true)

    - name: Validate TOML syntax using Python
      command: python3 -c "import tomllib; tomllib.loads(open('{{ containerd_config_path }}', 'rb').read())"
      register: toml_validation_py311
      changed_when: false
      failed_when: false
      when: check_toml_syntax | default(true)

    - name: Validate TOML syntax using toml library (fallback)
      command: python3 -c "import toml; toml.load('{{ containerd_config_path }}')"
      register: toml_validation_toml
      changed_when: false
      failed_when: false
      when: check_toml_syntax | default(true) and toml_validation_py311.rc != 0

    - name: Report TOML syntax errors
      debug:
        msg:
          - "TOML SYNTAX CHECK:"
          - "  Status: {{ 'FAIL' if (toml_validation_py311.rc != 0 and toml_validation_toml.rc != 0) else 'PASS' }}"
          - "  Error (tomllib): {{ toml_validation_py311.stderr if toml_validation_py311.rc != 0 else 'No errors' }}"
          - "  Error (toml): {{ toml_validation_toml.stderr if toml_validation_toml.rc != 0 and toml_validation_py311.rc != 0 else 'N/A' }}"
      when: check_toml_syntax | default(true)

    - name: Extract config content for analysis
      set_fact:
        config_content: "{{ containerd_config_content.content | b64decode }}"
      when: containerd_config_stat.stat.exists

    - name: Find duplicate enable_tls_streaming entries
      shell: |
        grep -n "^[[:space:]]*enable_tls_streaming[[:space:]]*=" "{{ containerd_config_path }}" || echo ""
      register: enable_tls_streaming_lines
      changed_when: false
      failed_when: false
      when: check_duplicates | default(true)

    - name: Count enable_tls_streaming occurrences
      set_fact:
        enable_tls_streaming_count: "{{ enable_tls_streaming_lines.stdout_lines | select('match', '.*') | list | length }}"
      when: check_duplicates | default(true)

    - name: Report duplicate enable_tls_streaming entries
      debug:
        msg:
          - "DUPLICATE CHECK - enable_tls_streaming:"
          - "  Status: {{ 'FAIL - DUPLICATE FOUND' if enable_tls_streaming_count | int > 1 else 'PASS' }}"
          - "  Occurrences: {{ enable_tls_streaming_count }}"
          - "  Lines: {{ enable_tls_streaming_lines.stdout_lines | join(', ') if enable_tls_streaming_lines.stdout_lines | length > 0 else 'Not found' }}"
      when: check_duplicates | default(true)

    - name: Find duplicate snapshotter entries
      shell: |
        grep -n "^[[:space:]]*snapshotter[[:space:]]*=" "{{ containerd_config_path }}" || echo ""
      register: snapshotter_lines
      changed_when: false
      failed_when: false
      when: check_duplicates | default(true)

    - name: Count snapshotter occurrences
      set_fact:
        snapshotter_count: "{{ snapshotter_lines.stdout_lines | select('match', '.*') | list | length }}"
      when: check_duplicates | default(true)

    - name: Report duplicate snapshotter entries
      debug:
        msg:
          - "DUPLICATE CHECK - snapshotter:"
          - "  Status: {{ 'FAIL - DUPLICATE FOUND' if snapshotter_count | int > 1 else 'PASS' }}"
          - "  Occurrences: {{ snapshotter_count }}"
          - "  Lines: {{ snapshotter_lines.stdout_lines | join(', ') if snapshotter_lines.stdout_lines | length > 0 else 'Not found' }}"
      when: check_duplicates | default(true)

    - name: Find duplicate systemd_cgroup entries
      shell: |
        grep -n "^[[:space:]]*systemd_cgroup[[:space:]]*=" "{{ containerd_config_path }}" || echo ""
      register: systemd_cgroup_lines
      changed_when: false
      failed_when: false
      when: check_duplicates | default(true)

    - name: Count systemd_cgroup occurrences
      set_fact:
        systemd_cgroup_count: "{{ systemd_cgroup_lines.stdout_lines | select('match', '.*') | list | length }}"
      when: check_duplicates | default(true)

    - name: Report duplicate systemd_cgroup entries
      debug:
        msg:
          - "DUPLICATE CHECK - systemd_cgroup:"
          - "  Status: {{ 'FAIL - DUPLICATE FOUND' if systemd_cgroup_count | int > 1 else 'PASS' }}"
          - "  Occurrences: {{ systemd_cgroup_count }}"
          - "  Lines: {{ systemd_cgroup_lines.stdout_lines | join(', ') if systemd_cgroup_lines.stdout_lines | length > 0 else 'Not found' }}"
      when: check_duplicates | default(true)

    - name: Extract enable_tls_streaming values
      shell: |
        grep "^[[:space:]]*enable_tls_streaming[[:space:]]*=" "{{ containerd_config_path }}" | sed 's/.*=[[:space:]]*//' | tr -d '[:space:]' || echo ""
      register: enable_tls_streaming_values
      changed_when: false
      failed_when: false
      when: check_duplicates | default(true) and enable_tls_streaming_count | int > 1

    - name: Report conflicting enable_tls_streaming values
      debug:
        msg:
          - "CONFLICT CHECK - enable_tls_streaming values:"
          - "  Values found: {{ enable_tls_streaming_values.stdout_lines | join(', ') }}"
          - "  Status: {{ 'FAIL - CONFLICTING VALUES' if enable_tls_streaming_values.stdout_lines | unique | list | length > 1 else 'PASS - Same values' }}"
      when: check_duplicates | default(true) and enable_tls_streaming_count | int > 1

    - name: Find all duplicate keys in TOML (simple pattern matching)
      shell: |
        # Extract all top-level keys and keys in sections (simple pattern)
        grep -E "^[a-zA-Z_][a-zA-Z0-9_]*[[:space:]]*=" "{{ containerd_config_path }}" | \
        sed 's/[[:space:]]*=.*//' | \
        sed 's/^[[:space:]]*//' | \
        sort | \
        uniq -d || echo ""
      register: duplicate_keys
      changed_when: false
      failed_when: false
      when: check_duplicates | default(true)

    - name: Report all duplicate keys
      debug:
        msg:
          - "DUPLICATE CHECK - All Keys (simple):"
          - "  Status: {{ 'FAIL - DUPLICATES FOUND' if duplicate_keys.stdout | length > 0 else 'PASS' }}"
          - "  Duplicate keys: {{ duplicate_keys.stdout_lines | join(', ') if duplicate_keys.stdout_lines | length > 0 else 'None' }}"
      when: check_duplicates | default(true) and duplicate_keys.stdout is defined

    - name: Parse TOML and check for duplicate keys (advanced check)
      shell: |
        python3 << 'EOF'
        import sys
        import re
        
        try:
            # Try tomllib first (Python 3.11+)
            try:
                import tomllib
                with open('{{ containerd_config_path }}', 'rb') as f:
                    config = tomllib.loads(f.read())
            except ImportError:
                # Fallback to toml library
                try:
                    import toml
                    with open('{{ containerd_config_path }}', 'r') as f:
                        config = toml.load(f)
                except ImportError:
                    print("ERROR: No TOML parser available (need tomllib or toml library)", file=sys.stderr)
                    sys.exit(1)
            
            # Read file to check for duplicate keys in same section
            with open('{{ containerd_config_path }}', 'r') as f:
                lines = f.readlines()
            
            # Track keys by section
            current_section = []
            keys_seen = {}
            duplicates = []
            
            for i, line in enumerate(lines, 1):
                stripped = line.strip()
                
                # Skip comments and empty lines
                if not stripped or stripped.startswith('#'):
                    continue
                
                # Check for section headers [section] or [section.subsection]
                section_match = re.match(r'^\[([^\]]+)\]', stripped)
                if section_match:
                    section_path = section_match.group(1).strip('"').strip("'")
                    current_section = section_path.split('.')
                    continue
                
                # Check for key = value
                key_match = re.match(r'^([a-zA-Z_][a-zA-Z0-9_]*)[[:space:]]*=', stripped)
                if key_match:
                    key = key_match.group(1)
                    section_key = '.'.join(current_section + [key]) if current_section else key
                    
                    if section_key in keys_seen:
                        duplicates.append(f"{section_key} (lines {keys_seen[section_key]} and {i})")
                    else:
                        keys_seen[section_key] = i
            
            if duplicates:
                print("DUPLICATES:", ",".join(duplicates))
            else:
                print("NO_DUPLICATES")
        except Exception as e:
            print(f"ERROR: {str(e)}", file=sys.stderr)
            sys.exit(1)
        EOF
      register: toml_duplicate_check
      changed_when: false
      failed_when: false
      when: check_duplicates | default(true)

    - name: Report TOML duplicate check results
      debug:
        msg:
          - "ADVANCED DUPLICATE CHECK (TOML parsing):"
          - "  Result: {{ toml_duplicate_check.stdout }}"
          - "  Status: {{ 'FAIL' if 'DUPLICATES:' in toml_duplicate_check.stdout else 'PASS' if 'NO_DUPLICATES' in toml_duplicate_check.stdout else 'ERROR' }}"
      when: check_duplicates | default(true) and toml_duplicate_check.stdout is defined

    - name: Check for common misconfigurations - insecure registries
      shell: |
        grep -i "insecure" "{{ containerd_config_path }}" || echo ""
      register: insecure_registry_check
      changed_when: false
      failed_when: false

    - name: Report insecure registry findings
      debug:
        msg:
          - "SECURITY CHECK - Insecure registries:"
          - "  Status: {{ 'WARN - Insecure registry found' if insecure_registry_check.stdout | length > 0 else 'PASS' }}"
          - "  Details: {{ insecure_registry_check.stdout_lines | join('; ') if insecure_registry_check.stdout_lines | length > 0 else 'None found' }}"
      when: insecure_registry_check.stdout is defined

    - name: Check for debug mode enabled
      shell: |
        grep -E "^[[:space:]]*level[[:space:]]*=" "{{ containerd_config_path }}" | grep -v "^[[:space:]]*#" | tail -1 | sed 's/.*=[[:space:]]*//' | tr -d '[:space:]' || echo ""
      register: debug_level_check
      changed_when: false
      failed_when: false

    - name: Report debug level
      debug:
        msg:
          - "SECURITY CHECK - Debug level:"
          - "  Status: {{ 'WARN - Debug enabled' if debug_level_check.stdout in ['debug', 'DEBUG', 'Debug'] else 'PASS' }}"
          - "  Level: {{ debug_level_check.stdout if debug_level_check.stdout else 'Not set or empty' }}"
      when: debug_level_check.stdout is defined

    - name: Check for required plugins
      shell: |
        grep -A 5 "^required_plugins" "{{ containerd_config_path }}" | grep -E "io.containerd.grpc.v1.cri" || echo ""
      register: required_plugins_check
      changed_when: false
      failed_when: false

    - name: Report required plugins check
      debug:
        msg:
          - "CONFIGURATION CHECK - Required plugins:"
          - "  Status: {{ 'PASS' if required_plugins_check.stdout | length > 0 else 'WARN - CRI plugin not found in required_plugins' }}"
          - "  CRI plugin found: {{ 'Yes' if required_plugins_check.stdout | length > 0 else 'No' }}"
      when: required_plugins_check.stdout is defined

    - name: Check systemd_cgroup setting
      shell: |
        grep -E "^[[:space:]]*systemd_cgroup[[:space:]]*=" "{{ containerd_config_path }}" | tail -1 | sed 's/.*=[[:space:]]*//' | tr -d '[:space:]' || echo ""
      register: systemd_cgroup_value
      changed_when: false
      failed_when: false

    - name: Report systemd_cgroup setting
      debug:
        msg:
          - "CONFIGURATION CHECK - systemd_cgroup:"
          - "  Status: {{ 'PASS' if systemd_cgroup_value.stdout == 'true' else 'WARN - systemd_cgroup should be true for Kubernetes' }}"
          - "  Value: {{ systemd_cgroup_value.stdout if systemd_cgroup_value.stdout else 'Not set' }}"
      when: systemd_cgroup_value.stdout is defined

    - name: Generate summary report
      set_fact:
        scan_summary:
          hostname: "{{ inventory_hostname }}"
          config_exists: "{{ containerd_config_stat.stat.exists }}"
          toml_valid: "{{ 'PASS' if (toml_validation_py311.rc == 0 or toml_validation_toml.rc == 0) else 'FAIL' }}"
          permissions_ok: "{{ 'PASS' if (containerd_config_perms.stat.mode | int) == 33188 and containerd_config_perms.stat.pw_name == 'root' and containerd_config_perms.stat.gr_name == 'root' else 'FAIL' }}"
          enable_tls_streaming_duplicate: "{{ 'FAIL' if enable_tls_streaming_count | int > 1 else 'PASS' }}"
          duplicate_keys_found: "{{ 'FAIL' if duplicate_keys.stdout | length > 0 else 'PASS' }}"
          toml_duplicates: "{{ 'FAIL' if 'DUPLICATES:' in toml_duplicate_check.stdout else 'PASS' if 'NO_DUPLICATES' in toml_duplicate_check.stdout else 'UNKNOWN' }}"

    - name: Display summary for {{ inventory_hostname }}
      debug:
        msg:
          - ""
          - "=== SCAN SUMMARY FOR {{ inventory_hostname }} ==="
          - "Config file exists: {{ scan_summary.config_exists }}"
          - "TOML syntax valid: {{ scan_summary.toml_valid }}"
          - "Permissions correct: {{ scan_summary.permissions_ok }}"
          - "enable_tls_streaming duplicate: {{ scan_summary.enable_tls_streaming_duplicate }}"
          - "Duplicate keys found: {{ scan_summary.duplicate_keys_found }}"
          - "TOML duplicate check: {{ scan_summary.toml_duplicates }}"
          - ""

  post_tasks:
    - name: Display final summary report header
      debug:
        msg:
          - ""
          - "=========================================="
          - "SCAN COMPLETED - Review output above"
          - "=========================================="
          - ""
          - "To see issues, look for nodes with:"
          - "  - 'FAIL' status in any check"
          - "  - 'DUPLICATE FOUND' messages"
          - "  - 'CONFLICTING VALUES' messages"
          - "  - 'WARN' messages for security/config issues"
          - ""
      run_once: true
      delegate_to: localhost

