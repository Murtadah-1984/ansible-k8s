---
# kubeadm init configuration
# CIS-compliant Kubernetes cluster initialization
apiVersion: kubeadm.k8s.io/v1beta3
kind: InitConfiguration
localAPIEndpoint:
  advertiseAddress: "{{ ansible_default_ipv4.address }}"
  bindPort: 6443
nodeRegistration:
  criSocket: unix:///var/run/containerd/containerd.sock
  kubeletExtraArgs:
    cgroup-driver: systemd
    # CIS 4.2.1 - Disable anonymous auth
    anonymous-auth: "false"
    # CIS 4.2.2 - Use Webhook authorization
    authorization-mode: "Webhook"
    # CIS 4.2.3 - Client CA file
    client-ca-file: "/etc/kubernetes/pki/ca.crt"
    # CIS 4.2.4 - Disable read-only port
    read-only-port: "0"
    # CIS 4.2.6 - Enable iptables management
    make-iptables-util-chains: "true"
    # CIS 4.2.10 - Enable certificate rotation
    rotate-certificates: "true"
    # CIS 4.2.11 - Server certificate rotation
    feature-gates: "RotateKubeletServerCertificate=true"
    # CIS 4.2.13 - Pod PIDs limit
    pod-max-pids: "{{ kubelet_pod_pids_limit | default('4096') }}"
  taints: []
---
apiVersion: kubeadm.k8s.io/v1beta3
kind: ClusterConfiguration
kubernetesVersion: "v{{ kubernetes_version }}"
clusterName: "{{ cluster_name | default('kubernetes') }}"
controlPlaneEndpoint: "{{ control_plane_endpoint | default('') }}"
networking:
  serviceSubnet: "{{ service_cidr | default('10.96.0.0/12') }}"
  podSubnet: "{{ pod_network_cidr | default('10.244.0.0/16') }}"
  dnsDomain: "{{ kubelet_cluster_domain | default('cluster.local') }}"
# CIS 1.2.1 - Disable anonymous auth
apiServer:
  extraArgs:
    anonymous-auth: "false"
    # CIS 1.2.6 - Authorization mode includes RBAC
    authorization-mode: "Node,RBAC"
    # CIS 1.2.16 - Disable profiling
    profiling: "false"
    # CIS 1.2.17 - Audit log path
    audit-log-path: "/var/log/audit/kube-apiserver-audit.log"
    # CIS 1.2.18 - Audit log maxage
    audit-log-maxage: "30"
    # CIS 1.2.19 - Audit log maxbackup
    audit-log-maxbackup: "10"
    # CIS 1.2.20 - Audit log maxsize
    audit-log-maxsize: "100"
    # CIS 1.2.22 - Service account lookup
    service-account-lookup: "true"
    # CIS 1.2.26 - Client CA file
    client-ca-file: "/etc/kubernetes/pki/ca.crt"
  extraVolumes:
    - name: audit-log
      hostPath: /var/log/audit
      mountPath: /var/log/audit
      pathType: DirectoryOrCreate
  certSANs:
    - "{{ ansible_default_ipv4.address }}"
    - "{{ inventory_hostname }}"
    {% if control_plane_endpoint is defined and control_plane_endpoint != '' %}
    - "{{ control_plane_endpoint.split(':')[0] }}"
    {% endif %}
# CIS 1.3.2 - Controller manager profiling disabled
controllerManager:
  extraArgs:
    profiling: "false"
    # CIS 1.3.3 - Use service account credentials
    use-service-account-credentials: "true"
    # CIS 1.3.6 - Rotate kubelet server certificate
    feature-gates: "RotateKubeletServerCertificate=true"
    # CIS 1.3.7 - Bind to localhost
    bind-address: "127.0.0.1"
# CIS 1.4.1 - Scheduler profiling disabled
scheduler:
  extraArgs:
    profiling: "false"
    # CIS 1.4.2 - Bind to localhost
    bind-address: "127.0.0.1"
# CIS 1.2.28, 1.2.29 - Encryption provider config
# Note: This should be configured separately for production
etcd:
  local:
    dataDir: /var/lib/etcd
    # CIS 2.1 - etcd cert and key files
    # CIS 2.2 - Client cert auth
    # CIS 2.4 - Peer cert and key files
    # CIS 2.5 - Peer client cert auth
    # Note: kubeadm handles etcd certificates automatically
dns:
  type: CoreDNS
---
apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration
# CIS 4.2.1 - Disable anonymous authentication
authentication:
  anonymous:
    enabled: false
  x509:
    clientCAFile: "/etc/kubernetes/pki/ca.crt"
# CIS 4.2.2 - Use Webhook authorization
authorization:
  mode: Webhook
# CIS 4.2.4 - Disable read-only port
readOnlyPort: 0
# CIS 4.2.5 - Set streaming connection idle timeout
streamingConnectionIdleTimeout: "{{ kubelet_streaming_connection_idle_timeout | default('5m') }}"
# CIS 4.2.6 - Enable iptables management
makeIPTablesUtilChains: true
# CIS 4.2.8 - Event recording
eventRecordQPS: {{ kubelet_event_record_qps | default(5) }}
# CIS 4.2.10 - Enable certificate rotation
rotateCertificates: true
# CIS 4.2.11 - Enable server certificate rotation
serverTLSBootstrap: true
# CIS 4.2.13 - Pod PIDs limit
podPidsLimit: {{ kubelet_pod_pids_limit | default(4096) }}
# Additional security settings
cgroupDriver: systemd
failSwapOn: true
clusterDomain: "{{ kubelet_cluster_domain | default('cluster.local') }}"
clusterDNS:
  - "{{ kubelet_cluster_dns | default('10.96.0.10') }}"

