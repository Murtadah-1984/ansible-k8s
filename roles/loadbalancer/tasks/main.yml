---
# Loadbalancer Role - Main Entry Point
# Orchestrates HAProxy and Keepalived installation

# =============================================================================
# BUILD CONTROL PLANE NODES LIST
# =============================================================================
# Build the control plane nodes list before it's needed by HAProxy configuration
- name: Build control plane nodes list
  set_fact:
    control_plane_nodes: "{{ control_plane_nodes | default([]) + [{'name': item, 'ip': hostvars[item]['ansible_host']}] }}"
  loop: "{{ groups['control'] }}"
  run_once: true
  when: control_plane_nodes | default([]) | length == 0

# =============================================================================
# PACKAGE INSTALLATION
# =============================================================================
- name: Install packages
  include_tasks: packages.yml

# =============================================================================
# KEEPALIVED CONFIGURATION
# =============================================================================
- name: Configure Keepalived
  include_tasks: keepalived.yml

# =============================================================================
# HAPROXY CONFIGURATION
# =============================================================================
- name: Configure HAProxy
  include_tasks: haproxy.yml

# =============================================================================
# SERVICE MANAGEMENT
# =============================================================================
- name: Enable and start services
  include_tasks: services.yml

# =============================================================================
# DISPLAY INSTALLATION INFORMATION
# =============================================================================
- name: Display installation information
  debug:
    msg:
      - "======================================================"
      - "  HAProxy & Keepalived Installation"
      - "======================================================"
      - ""
      - "Target hosts: Load balancer nodes [lb]"
      - "Services to install:"
      - "  - HAProxy (load balancer)"
      - "  - Keepalived (high availability)"
      - ""
      - "Control plane backend nodes:"
      - "  {{ control_plane_nodes | map(attribute='name') | join(', ') }}"
      - ""
      - "======================================================"
  run_once: true

# =============================================================================
# VERIFICATION
# =============================================================================
- name: Verify services
  include_tasks: verification.yml

