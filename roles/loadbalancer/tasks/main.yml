---
# Loadbalancer Role - Main Entry Point
# Orchestrates HAProxy and Keepalived installation

# =============================================================================
# PACKAGE INSTALLATION
# =============================================================================
- name: Install packages
  include_tasks: packages.yml

# =============================================================================
# KEEPALIVED CONFIGURATION
# =============================================================================
- name: Configure Keepalived
  include_tasks: keepalived.yml

# =============================================================================
# HAPROXY CONFIGURATION
# =============================================================================
- name: Configure HAProxy
  include_tasks: haproxy.yml

# =============================================================================
# SERVICE MANAGEMENT
# =============================================================================
- name: Enable and start services
  include_tasks: services.yml

# =============================================================================
# VERIFICATION
# =============================================================================
- name: Verify services
  include_tasks: verification.yml
  set_fact:
    control_plane_nodes: "{{ control_plane_nodes | default([]) + [{'name': item, 'ip': hostvars[item]['ansible_host']}] }}"
  loop: "{{ groups['control'] }}"
  run_once: true
  when: control_plane_nodes | default([]) | length == 0

- name: Display installation information
  debug:
    msg:
      - "======================================================"
      - "  HAProxy & Keepalived Installation"
      - "======================================================"
      - ""
      - "Target hosts: Load balancer nodes [lb]"
      - "Services to install:"
      - "  - HAProxy (load balancer)"
      - "  - Keepalived (high availability)"
      - ""
      - "Control plane backend nodes:"
      - "  {{ control_plane_nodes | map(attribute='name') | join(', ') }}"
      - ""
      - "======================================================"
  run_once: true

# =============================================================================
# 1) INSTALL PACKAGES
# =============================================================================
- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Install HAProxy
  apt:
    name: haproxy
    state: present

- name: Install Keepalived
  apt:
    name: keepalived
    state: present

- name: Install curl (required for health check script)
  apt:
    name: curl
    state: present

# =============================================================================
# 2) CREATE KEEPALIVED HEALTH CHECK SCRIPT
# =============================================================================
- name: Ensure keepalived configuration directory exists
  file:
    path: /etc/keepalived
    state: directory
    mode: '0755'

- name: Create Keepalived health check script
  copy:
    dest: /etc/keepalived/check_apiserver.sh
    content: |
      #!/bin/sh
      APISERVER_DEST_PORT=8443
      errorExit() {
          echo "*** $*" 1>&2
          exit 1
      }
      # Check API-server health through HAProxy on localhost:8443
      curl -sfk --max-time 2 "https://localhost:${APISERVER_DEST_PORT}/healthz" -o /dev/null \
        || errorExit "Error GET https://localhost:${APISERVER_DEST_PORT}/healthz"
    mode: '0755'
    owner: root
    group: root

# =============================================================================
# 2.5) DETECT NETWORK INTERFACE AND DETERMINE KEEPALIVED ROLE
# =============================================================================
- name: Get default network interface
  set_fact:
    keepalived_interface_detected: "{{ ansible_default_ipv4.interface }}"
  when: ansible_default_ipv4 is defined

- name: Set network interface for Keepalived
  set_fact:
    keepalived_interface_final: "{{ keepalived_interface if keepalived_interface else keepalived_interface_detected }}"

- name: Determine Keepalived role (MASTER for first node, BACKUP for others)
  set_fact:
    keepalived_role: "{{ 'MASTER' if groups['lb'][0] == inventory_hostname else 'BACKUP' }}"
    keepalived_priority: "{{ 101 if groups['lb'][0] == inventory_hostname else 90 }}"

- name: Display Keepalived configuration
  debug:
    msg:
      - "Keepalived role: {{ keepalived_role }}"
      - "Priority: {{ keepalived_priority }}"
      - "Interface: {{ keepalived_interface_final }}"
      - "Virtual IP: {{ keepalived_virtual_ip }}"

# =============================================================================
# 2.6) CREATE KEEPALIVED CONFIGURATION
# =============================================================================
- name: Check if Keepalived configuration exists
  stat:
    path: /etc/keepalived/keepalived.conf
  register: keepalived_config_stat

- name: Backup existing Keepalived configuration
  copy:
    src: /etc/keepalived/keepalived.conf
    dest: /etc/keepalived/keepalived.conf.backup
    remote_src: yes
  when: keepalived_config_stat.stat.exists
  failed_when: false

- name: Create Keepalived configuration
  copy:
    dest: /etc/keepalived/keepalived.conf
    content: |
      ! /etc/keepalived/keepalived.conf
      global_defs {
          router_id K8S_CP_VRRP
      }
      vrrp_script check_apiserver {
        script "/etc/keepalived/check_apiserver.sh"
        interval 3
        weight -2
        fall 10
        rise 2
      }
      vrrp_instance VI_1 {
          state {{ keepalived_role }}
          interface {{ keepalived_interface_final }}
          virtual_router_id {{ keepalived_virtual_router_id }}
          priority {{ keepalived_priority }}
          authentication {
              auth_type PASS
              auth_pass {{ keepalived_auth_pass }}
          }
          virtual_ipaddress {
              {{ keepalived_virtual_ip }}
          }
          track_script {
              check_apiserver
          }
      {% if keepalived_role == 'MASTER' %}
          nopreempt
      {% endif %}
      }
    mode: '0644'
    owner: root
    group: root

# =============================================================================
# 3) VALIDATE KEEPALIVED CONFIGURATION
# =============================================================================
- name: Validate Keepalived configuration
  command: keepalived -t -f /etc/keepalived/keepalived.conf
  register: keepalived_validate
  changed_when: false
  failed_when: false

- name: Display Keepalived validation result
  debug:
    msg: "{{ keepalived_validate.stdout_lines + keepalived_validate.stderr_lines }}"
  when: keepalived_validate.stdout_lines is defined or keepalived_validate.stderr_lines is defined

# =============================================================================
# 4) CREATE HAPROXY CONFIGURATION
# =============================================================================
- name: Check if HAProxy configuration exists
  stat:
    path: /etc/haproxy/haproxy.cfg
  register: haproxy_config_stat

- name: Backup existing HAProxy configuration
  copy:
    src: /etc/haproxy/haproxy.cfg
    dest: /etc/haproxy/haproxy.cfg.backup
    remote_src: yes
  when: haproxy_config_stat.stat.exists
  failed_when: false

- name: Create HAProxy configuration
  copy:
    dest: /etc/haproxy/haproxy.cfg
    content: |
      #---------------------------------------------------------------------
      # Global settings
      #---------------------------------------------------------------------
      global
          log stdout format raw local0
          daemon
      #---------------------------------------------------------------------
      # common defaults that all the 'listen' and 'backend' sections will
      # use if not designated in their block
      #---------------------------------------------------------------------
      defaults
          mode                    http
          log                     global
          option                  httplog
          option                  dontlognull
          option http-server-close
          option forwardfor       except 127.0.0.0/8
          option                  redispatch
          retries                 1
          timeout http-request    10s
          timeout queue           20s
          timeout connect         5s
          timeout client          35s
          timeout server          35s
          timeout http-keep-alive 10s
          timeout check           10s
      #---------------------------------------------------------------------
      # apiserver frontend which proxys to the control plane nodes
      #---------------------------------------------------------------------
      frontend apiserver
          bind *:8443
          mode tcp
          option tcplog
          default_backend apiserverbackend
      backend apiserverbackend
          option httpchk
          http-check connect ssl
          http-check send meth GET uri /healthz
          http-check expect status 200
          mode tcp
          balance     roundrobin
{% for node in control_plane_nodes %}
          server {{ node.name }} {{ node.ip }}:6443 check verify none
{% endfor %}
    mode: '0644'
    owner: root
    group: root

# =============================================================================
# 5) VALIDATE HAPROXY CONFIGURATION
# =============================================================================
- name: Validate HAProxy configuration
  command: haproxy -c -f /etc/haproxy/haproxy.cfg
  register: haproxy_validate
  changed_when: false

- name: Display HAProxy validation result
  debug:
    msg: "{{ haproxy_validate.stdout_lines }}"

# =============================================================================
# 6) ENABLE AND START SERVICES
# =============================================================================
- name: Enable HAProxy service
  systemd:
    name: haproxy
    enabled: yes

- name: Start HAProxy service
  systemd:
    name: haproxy
    state: started
    daemon_reload: yes

- name: Enable Keepalived service
  systemd:
    name: keepalived
    enabled: yes

- name: Start Keepalived service
  systemd:
    name: keepalived
    state: started
    daemon_reload: yes

# =============================================================================
# 7) VERIFY SERVICES STATUS
# =============================================================================
- name: Check HAProxy service status
  systemd:
    name: haproxy
  register: haproxy_status
  changed_when: false

- name: Check Keepalived service status
  systemd:
    name: keepalived
  register: keepalived_status
  changed_when: false

- name: Display installation summary
  debug:
    msg:
      - "======================================================"
      - "âœ” Installation completed on {{ inventory_hostname }}"
      - ""
      - "HAProxy status: {{ haproxy_status.status.ActiveState }}"
      - "Keepalived status: {{ keepalived_status.status.ActiveState }}"
      - ""
      - "Configuration files:"
      - "  - /etc/haproxy/haproxy.cfg"
      - "  - /etc/keepalived/keepalived.conf"
      - "  - /etc/keepalived/check_apiserver.sh"
      - ""
      - "HAProxy is listening on port 8443"
      - "Keepalived role: {{ keepalived_role }} (priority: {{ keepalived_priority }})"
      - "Keepalived virtual IP: {{ keepalived_virtual_ip }}"
      - "Keepalived interface: {{ keepalived_interface_final }}"
      - ""
      - "Backend control plane nodes:"
      - "  {{ control_plane_nodes | map(attribute='name') | join(', ') }}"
      - ""
      - "======================================================"

