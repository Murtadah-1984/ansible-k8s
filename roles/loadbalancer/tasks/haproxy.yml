---
# HAProxy Configuration
# Configures HAProxy load balancer

# =============================================================================
# 4) CREATE HAPROXY CONFIGURATION
# =============================================================================
- name: Check if HAProxy configuration exists
  stat:
    path: /etc/haproxy/haproxy.cfg
  register: haproxy_config_stat

- name: Backup existing HAProxy configuration
  copy:
    src: /etc/haproxy/haproxy.cfg
    dest: /etc/haproxy/haproxy.cfg.backup
    remote_src: yes
  when: haproxy_config_stat.stat.exists
  failed_when: false

- name: Create HAProxy configuration
  copy:
    dest: /etc/haproxy/haproxy.cfg
    content: |
      #---------------------------------------------------------------------
      # Global settings
      #---------------------------------------------------------------------
      global
          log stdout format raw local0
          daemon
      #---------------------------------------------------------------------
      # common defaults that all the 'listen' and 'backend' sections will
      # use if not designated in their block
      #---------------------------------------------------------------------
      defaults
          mode                    http
          log                     global
          option                  httplog
          option                  dontlognull
          option http-server-close
          option forwardfor       except 127.0.0.0/8
          option                  redispatch
          retries                 1
          timeout http-request    10s
          timeout queue           20s
          timeout connect         5s
          timeout client          35s
          timeout server          35s
          timeout http-keep-alive 10s
          timeout check           10s
      #---------------------------------------------------------------------
      # apiserver frontend which proxys to the control plane nodes
      #---------------------------------------------------------------------
      frontend apiserver
          bind *:8443
          mode tcp
          option tcplog
          default_backend apiserverbackend
      backend apiserverbackend
          option httpchk
          http-check connect ssl
          http-check send meth GET uri /healthz
          http-check expect status 200
          mode tcp
          balance     roundrobin
{% for node in control_plane_nodes %}
          server {{ node.name }} {{ node.ip }}:6443 check verify none
{% endfor %}
    mode: '0644'
    owner: root
    group: root

# =============================================================================
# 5) VALIDATE HAPROXY CONFIGURATION
# =============================================================================
- name: Validate HAProxy configuration
  command: haproxy -c -f /etc/haproxy/haproxy.cfg
  register: haproxy_validate
  changed_when: false

- name: Display HAProxy validation result
  debug:
    msg: "{{ haproxy_validate.stdout_lines }}"

