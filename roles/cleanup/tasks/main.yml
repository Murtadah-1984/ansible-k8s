---
# Cleanup Role - Main Entry Point
# Orchestrates system cleanup and optimization

# ============================================================================
# PACKAGE CLEANUP
# ============================================================================
- name: Clean up packages
  include_tasks: packages.yml

# ============================================================================
# LOG CLEANUP
# ============================================================================
- name: Clean up log files
  include_tasks: logs.yml

# ============================================================================
# TEMPORARY FILES CLEANUP
# ============================================================================
- name: Clean up temporary files
  include_tasks: temp_files.yml
  apt:
    autoremove: yes
    autoclean: yes
    update_cache: false

- name: Clear package cache
  apt:
    clean: yes
    update_cache: false

# ============================================================================
# LOG CLEANUP (selective - preserve important Kubernetes logs)
# ============================================================================
- name: Find old log files to remove (preserving Kubernetes logs)
  find:
    paths: /var/log
    patterns:
      - "*.log"
      - "*.gz"
    age: "+7d"
    excludes:
      - "*/kubelet*"
      - "*/containerd*"
      - "*/audit*"
    file_type: file
  register: old_log_files
  failed_when: false

- name: Remove old log files
  file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ old_log_files.files | default([]) }}"
  failed_when: false

- name: Vacuum journald logs (time-based)
  command: journalctl --vacuum-time=7d
  changed_when: true
  failed_when: false

- name: Vacuum journald logs (size-based)
  command: journalctl --vacuum-size=100M
  changed_when: true
  failed_when: false

# ============================================================================
# TEMPORARY FILES CLEANUP
# ============================================================================
- name: Find old temporary files
  find:
    paths: /tmp
    age: "+1d"
    file_type: file
    recurse: false
  register: old_tmp_files
  failed_when: false

- name: Remove old temporary files
  file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ old_tmp_files.files | default([]) }}"
  failed_when: false

- name: Clean /var/tmp directory
  file:
    path: /var/tmp
    state: directory
  failed_when: false

- name: Remove contents of /var/tmp
  find:
    paths: /var/tmp
    file_type: any
  register: var_tmp_files
  failed_when: false

- name: Remove /var/tmp files
  file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ var_tmp_files.files | default([]) }}"
  failed_when: false
