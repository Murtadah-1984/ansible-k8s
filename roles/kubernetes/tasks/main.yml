# Pre-flight checks for Kubernetes installation
- name: Verify swap is disabled (CIS requirement)
  command: swapon --show
  register: swap_status
  changed_when: false
  failed_when: false

- name: Fail if swap is enabled
  assert:
    that:
      - swap_status.stdout == ""
    fail_msg: "FAIL: Swap is enabled. Kubernetes requires swap to be disabled (CIS requirement)."
    success_msg: "PASS: Swap is disabled"

- name: Verify required kernel modules are loaded
  command: lsmod | grep -E "^(overlay|br_netfilter)"
  register: kernel_modules
  changed_when: false
  failed_when: false

- name: Warn if kernel modules not loaded
  debug:
    msg: "WARNING: Required kernel modules (overlay, br_netfilter) may not be loaded. Ensure kernal role runs before kubernetes role."

- name: Aggressively remove all Kubernetes repository entries (fix conflicts)
  shell: |
    # Remove all Kubernetes repository files
    rm -f /etc/apt/sources.list.d/*kubernetes* /etc/apt/sources.list.d/*k8s* 2>/dev/null || true
    
    # Remove Kubernetes repository lines from sources.list
    sed -i '/pkgs\.k8s\.io/d' /etc/apt/sources.list 2>/dev/null || true
    
    # Remove any lines containing kubernetes or k8s from all sources.list.d files
    find /etc/apt/sources.list.d -type f -exec sed -i '/pkgs\.k8s\.io/d' {} \; 2>/dev/null || true
  changed_when: false
  failed_when: false

- name: Verify no Kubernetes repository entries remain
  shell: |
    grep -r "pkgs\.k8s\.io" /etc/apt/sources.list /etc/apt/sources.list.d/ 2>/dev/null || echo "No entries found"
  register: k8s_repo_check
  changed_when: false
  failed_when: false

- name: Display remaining Kubernetes repository entries (if any)
  debug:
    msg: "WARNING: Found remaining Kubernetes repository entries: {{ k8s_repo_check.stdout }}"
  when: k8s_repo_check.stdout != "No entries found" and k8s_repo_check.stdout != ""

- name: Clear APT cache after cleanup
  command: apt-get clean
  changed_when: false
  failed_when: false

- name: Ensure apt keyring directory exists
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'

- name: Ensure curl and gpg are installed
  apt:
    name:
      - curl
      - gnupg
    state: present
    update_cache: false
  failed_when: false

- name: Download Kubernetes GPG key (ASCII format) - try primary URL
  get_url:
    url: https://pkgs.k8s.io/core:/stable:/v{{ kubernetes_version }}/deb/Release.key
    dest: /tmp/kubernetes-release.key
    mode: '0644'
  register: gpg_download_primary
  failed_when: false

- name: Download Kubernetes GPG key (ASCII format) - try alternative URL
  get_url:
    url: https://prod-cdn.packages.k8s.io/repositories/isv:/kubernetes:/core:/stable:/v{{ kubernetes_version }}/deb/Release.key
    dest: /tmp/kubernetes-release.key
    mode: '0644'
  when: gpg_download_primary.failed
  register: gpg_download_alt
  failed_when: false

- name: Fail if GPG key download failed
  fail:
    msg: "Failed to download Kubernetes GPG key from both primary and alternative URLs"
  when: gpg_download_primary.failed and (gpg_download_alt.failed | default(true))

- name: Convert GPG key to binary format for keyrings directory
  shell: |
    gpg --dearmor < /tmp/kubernetes-release.key > /etc/apt/keyrings/kubernetes-apt-keyring.gpg
    chmod 644 /etc/apt/keyrings/kubernetes-apt-keyring.gpg
  register: gpg_convert_keyrings

- name: Also add GPG key to trusted keyring (fallback for compatibility)
  shell: |
    gpg --dearmor < /tmp/kubernetes-release.key > /etc/apt/trusted.gpg.d/kubernetes-apt-keyring.gpg
    chmod 644 /etc/apt/trusted.gpg.d/kubernetes-apt-keyring.gpg
  failed_when: false
  changed_when: true

- name: Verify GPG key contains expected key ID
  shell: |
    gpg --no-default-keyring --keyring /etc/apt/keyrings/kubernetes-apt-keyring.gpg --list-keys 2>/dev/null | grep -i "234654DA9A296436" || echo "Key ID not found in keyring"
  register: gpg_key_check
  changed_when: false
  failed_when: false

- name: Display GPG key information
  debug:
    msg: "GPG key check result: {{ gpg_key_check.stdout }}"

- name: Clean up temporary key file
  file:
    path: /tmp/kubernetes-release.key
    state: absent
  failed_when: false

- name: Verify GPG key was downloaded and is valid
  stat:
    path: /etc/apt/keyrings/kubernetes-apt-keyring.gpg
  register: gpg_key_stat

- name: Verify GPG key file is not empty
  assert:
    that:
      - gpg_key_stat.stat.exists
      - gpg_key_stat.stat.size > 0
    fail_msg: "Kubernetes GPG key download failed or file is empty"
    success_msg: "Kubernetes GPG key downloaded successfully ({{ gpg_key_stat.stat.size }} bytes)"

- name: Create Kubernetes repository file directly (ensures correct format)
  copy:
    content: "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v{{ kubernetes_version }}/deb/ /\n"
    dest: /etc/apt/sources.list.d/kubernetes.list
    mode: '0644'
    owner: root
    group: root

- name: Update APT cache after repository addition
  command: apt-get update
  changed_when: false

- name: Install Kubernetes components
  apt:
    name:
      - kubelet
      - kubeadm
      - kubectl
    state: present

- name: Hold Kubernetes packages
  command: apt-mark hold kubelet kubeadm kubectl
  changed_when: false

- name: Ensure kubelet config directory exists
  file:
    path: /var/lib/kubelet
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Configure kubelet
  template:
    src: kubelet-config.yaml.j2
    dest: /var/lib/kubelet/config.yaml
    owner: root
    group: root
    mode: '0600'
  notify: restart kubelet

# CIS 4.1.9 & 4.1.10 - Ensure kubelet config.yaml permissions and ownership
# Note: Permissions and ownership are already set in the template task above
# This task ensures they remain correct even if file is modified elsewhere
- name: Verify kubelet config.yaml permissions and ownership (CIS 4.1.9, 4.1.10)
  file:
    path: /var/lib/kubelet/config.yaml
    mode: '0600'
    owner: root
    group: root

# CIS 4.1.1 & 4.1.2 - Ensure kubelet service file permissions and ownership
- name: Check if kubelet service files exist
  stat:
    path: "{{ item }}"
  register: kubelet_service_files
  loop:
    - /etc/systemd/system/kubelet.service
    - /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
  ignore_errors: true

- name: Set kubelet service file permissions and ownership (CIS 4.1.1, 4.1.2)
  file:
    path: "{{ item.item }}"
    mode: '0600'
    owner: root
    group: root
  loop: "{{ kubelet_service_files.results }}"
  when: item.stat.exists

# CIS 4.1.5 & 4.1.6 - Ensure kubelet.conf file permissions and ownership
- name: Check if kubelet.conf exists
  stat:
    path: /etc/kubernetes/kubelet.conf
  register: kubelet_conf_stat
  ignore_errors: true

- name: Set kubelet.conf file permissions and ownership (CIS 4.1.5, 4.1.6)
  file:
    path: /etc/kubernetes/kubelet.conf
    mode: '0600'
    owner: root
    group: root
  when: kubelet_conf_stat.stat.exists

# CIS 4.1.7 & 4.1.8 - Ensure certificate authorities file permissions and ownership
- name: Check if client CA file exists
  stat:
    path: "{{ kubelet_client_ca_file | default('/etc/kubernetes/pki/ca.crt') }}"
  register: client_ca_file_stat
  ignore_errors: true

- name: Set certificate authorities file permissions and ownership (CIS 4.1.7, 4.1.8)
  file:
    path: "{{ kubelet_client_ca_file | default('/etc/kubernetes/pki/ca.crt') }}"
    mode: '0600'
    owner: root
    group: root
  when: client_ca_file_stat.stat.exists

# CIS 4.2.7 - Ensure hostname-override is not set
- name: Check kubelet service files for hostname-override
  shell: |
    grep -r "hostname-override" /etc/systemd/system/kubelet.service* 2>/dev/null || true
  register: hostname_override_check
  changed_when: false
  failed_when: false

- name: Verify hostname-override is not set (CIS 4.2.7)
  assert:
    that:
      - hostname_override_check.stdout == ""
    fail_msg: "FAIL: hostname-override argument found in kubelet service files (CIS 4.2.7)"
    success_msg: "PASS: hostname-override not set (CIS 4.2.7)"

# CIS 4.1.3 & 4.1.4 - Proxy kubeconfig file permissions and ownership (if exists)
- name: Find proxy kubeconfig files
  find:
    paths:
      - /etc/kubernetes
      - /var/lib/kube-proxy
    patterns:
      - "kube-proxy*.conf"
      - "proxy*.conf"
    file_type: file
  register: proxy_kubeconfig_files
  ignore_errors: true

- name: Set proxy kubeconfig file permissions and ownership (CIS 4.1.3, 4.1.4)
  file:
    path: "{{ item.path }}"
    mode: '0600'
    owner: root
    group: root
  loop: "{{ proxy_kubeconfig_files.files | default([]) }}"
  when: proxy_kubeconfig_files.files is defined and proxy_kubeconfig_files.files | length > 0

# CNI Configuration file security (CIS 4.1.9, 4.1.10 equivalent for CNI)
- name: Find CNI configuration files
  find:
    paths:
      - /etc/cni/net.d
    patterns:
      - "*.conf"
      - "*.conflist"
    file_type: file
  register: cni_config_files
  ignore_errors: true

- name: Set CNI configuration file permissions and ownership
  file:
    path: "{{ item.path }}"
    mode: '0600'
    owner: root
    group: root
  loop: "{{ cni_config_files.files | default([]) }}"
  when: cni_config_files.files is defined and cni_config_files.files | length > 0
