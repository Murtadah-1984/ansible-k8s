---
# Kubernetes Role - Main Entry Point
# Orchestrates Kubernetes installation and configuration

# ============================================================================
# PRE-FLIGHT CHECKS
# ============================================================================
- name: Run pre-flight checks
  include_tasks: preflight.yml

# ============================================================================
# REPOSITORY SETUP
# ============================================================================
- name: Setup Kubernetes repository
  include_tasks: repository.yml

# ============================================================================
# PACKAGE INSTALLATION
# ============================================================================
- name: Install Kubernetes packages
  include_tasks: installation.yml

# ============================================================================
# CRICTL INSTALLATION
# ============================================================================
- name: Install and configure crictl
  include_tasks: crictl.yml

# ============================================================================
# KUBELET CONFIGURATION
# ============================================================================
- name: Configure kubelet
  include_tasks: kubelet.yml

# ============================================================================
# CIS COMPLIANCE
# ============================================================================
- name: Apply CIS compliance settings
  include_tasks: cis_compliance.yml
  command: swapon --show
  register: swap_status
  changed_when: false
  failed_when: false

- name: Fail if swap is enabled
  assert:
    that:
      - swap_status.stdout == ""
    fail_msg: "FAIL: Swap is enabled. Kubernetes requires swap to be disabled (CIS requirement)."
    success_msg: "PASS: Swap is disabled"

- name: Verify required kernel modules are loaded
  command: lsmod | grep -E "^(overlay|br_netfilter)"
  register: kernel_modules
  changed_when: false
  failed_when: false

- name: Warn if kernel modules not loaded
  debug:
    msg: "WARNING: Required kernel modules (overlay, br_netfilter) may not be loaded. Ensure kernal role runs before kubernetes role."

- name: Find Kubernetes repository files to remove
  find:
    paths: /etc/apt/sources.list.d
    patterns:
      - "*kubernetes*"
      - "*k8s*"
    file_type: file
  register: k8s_repo_files
  failed_when: false
  changed_when: false

- name: Remove Kubernetes repository files
  file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ k8s_repo_files.files | default([]) }}"
  failed_when: false

- name: Remove Kubernetes repository lines from sources.list
  lineinfile:
    path: /etc/apt/sources.list
    regexp: 'pkgs\.k8s\.io'
    state: absent
  failed_when: false

- name: Find all files in sources.list.d that might contain Kubernetes repos
  find:
    paths: /etc/apt/sources.list.d
    file_type: file
  register: sources_list_d_files
  failed_when: false
  changed_when: false

- name: Remove Kubernetes repository lines from sources.list.d files
  lineinfile:
    path: "{{ item.path }}"
    regexp: 'pkgs\.k8s\.io'
    state: absent
  loop: "{{ sources_list_d_files.files | default([]) }}"
  failed_when: false

- name: Verify no Kubernetes repository entries remain
  shell: |
    grep -r "pkgs\.k8s\.io" /etc/apt/sources.list /etc/apt/sources.list.d/ 2>/dev/null || echo "No entries found"
  register: k8s_repo_check
  changed_when: false
  failed_when: false

- name: Display remaining Kubernetes repository entries (if any)
  debug:
    msg: "WARNING: Found remaining Kubernetes repository entries: {{ k8s_repo_check.stdout }}"
  when: k8s_repo_check.stdout != "No entries found" and k8s_repo_check.stdout != ""

- name: Clear APT cache after cleanup
  apt:
    update_cache: false
    cache_valid_time: 0
  failed_when: false

- name: Ensure apt keyring directory exists
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'

- name: Ensure curl and gpg are installed
  apt:
    name:
      - curl
      - gnupg
    state: present
    update_cache: false
  failed_when: false

- name: Download Kubernetes GPG key (ASCII format) - try primary URL
  get_url:
    url: https://pkgs.k8s.io/core:/stable:/v{{ kubernetes_version }}/deb/Release.key
    dest: /tmp/kubernetes-release.key
    mode: '0644'
  register: gpg_download_primary
  failed_when: false

- name: Download Kubernetes GPG key (ASCII format) - try alternative URL
  get_url:
    url: https://prod-cdn.packages.k8s.io/repositories/isv:/kubernetes:/core:/stable:/v{{ kubernetes_version }}/deb/Release.key
    dest: /tmp/kubernetes-release.key
    mode: '0644'
  when: gpg_download_primary.failed
  register: gpg_download_alt
  failed_when: false

- name: Fail if GPG key download failed
  fail:
    msg: "Failed to download Kubernetes GPG key from both primary and alternative URLs"
  when: gpg_download_primary.failed and (gpg_download_alt.failed | default(true))

- name: Convert GPG key to binary format for keyrings directory
  shell: |
    gpg --dearmor < /tmp/kubernetes-release.key > /etc/apt/keyrings/kubernetes-apt-keyring.gpg
    chmod 644 /etc/apt/keyrings/kubernetes-apt-keyring.gpg
  register: gpg_convert_keyrings

- name: Also add GPG key to trusted keyring (fallback for compatibility)
  shell: |
    gpg --dearmor < /tmp/kubernetes-release.key > /etc/apt/trusted.gpg.d/kubernetes-apt-keyring.gpg
    chmod 644 /etc/apt/trusted.gpg.d/kubernetes-apt-keyring.gpg
  failed_when: false
  changed_when: true

- name: Verify GPG key contains expected key ID
  shell: |
    gpg --no-default-keyring --keyring /etc/apt/keyrings/kubernetes-apt-keyring.gpg --list-keys 2>/dev/null | grep -i "234654DA9A296436" || echo "Key ID not found in keyring"
  register: gpg_key_check
  changed_when: false
  failed_when: false

- name: Display GPG key information
  debug:
    msg: "GPG key check result: {{ gpg_key_check.stdout }}"

- name: Clean up temporary key file
  file:
    path: /tmp/kubernetes-release.key
    state: absent
  failed_when: false

- name: Verify GPG key was downloaded and is valid
  stat:
    path: /etc/apt/keyrings/kubernetes-apt-keyring.gpg
  register: gpg_key_stat

- name: Verify GPG key file is not empty
  assert:
    that:
      - gpg_key_stat.stat.exists
      - gpg_key_stat.stat.size > 0
    fail_msg: "Kubernetes GPG key download failed or file is empty"
    success_msg: "Kubernetes GPG key downloaded successfully ({{ gpg_key_stat.stat.size }} bytes)"

- name: Create Kubernetes repository file directly (ensures correct format)
  copy:
    content: "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v{{ kubernetes_version }}/deb/ /\n"
    dest: /etc/apt/sources.list.d/kubernetes.list
    mode: '0644'
    owner: root
    group: root

- name: Update APT cache after repository addition
  apt:
    update_cache: true
    cache_valid_time: 3600

- name: Auto-detect exact Kubernetes version from repository
  block:
    - name: Get Kubernetes minor version
      set_fact:
        k8s_minor_version: "{{ kubernetes_version | regex_replace('^(\\d+\\.\\d+).*', '\\1') }}"
        k8s_repo_version: "v{{ kubernetes_version | regex_replace('^(\\d+\\.\\d+).*', '\\1') }}"

    - name: Check if version is minor or full
      set_fact:
        is_minor_version: "{{ kubernetes_version is match('^\\d+\\.\\d+$') }}"

    - name: Get available versions from repository
      command: apt-cache madison kubeadm
      register: kubeadm_versions
      changed_when: false

    - name: Extract matching version for minor version
      set_fact:
        available_version: "{{ (kubeadm_versions.stdout_lines | select('match', '.*' + kubernetes_version + '\\.') | map('regex_replace', '.*\\s+(\\S+).*', '\\1') | list | first) | default('') }}"
      when: is_minor_version | bool

    - name: Extract exact matching version for full version
      set_fact:
        available_version: "{{ (kubeadm_versions.stdout_lines | select('match', '.*' + kubernetes_version) | map('regex_replace', '.*\\s+(\\S+).*', '\\1') | list | first) | default('') }}"
      when: not (is_minor_version | bool)

    - name: Fail if version not found
      fail:
        msg: "Kubernetes version {{ kubernetes_version }} not found in repository. Available versions: {{ kubeadm_versions.stdout_lines[:5] | join(', ') }}"
      when: available_version == '' or available_version is not defined

    - name: Store pure version for image preloading
      set_fact:
        k8s_pure_version: "{{ available_version | regex_replace('^(\\d+\\.\\d+\\.\\d+).*', '\\1') }}"

- name: Install Kubernetes components with detected version
  apt:
    name:
      - "kubectl={{ available_version }}"
      - "kubelet={{ available_version }}"
      - "kubeadm={{ available_version }}"
    state: present
    update_cache: false
  when: available_version is defined and available_version != ''

- name: Hold Kubernetes packages
  command: apt-mark hold kubelet kubeadm kubectl
  changed_when: false
  failed_when: false

# ============================================================================
# CRICTL INSTALLATION
# ============================================================================
- name: Check if crictl is installed
  command: which crictl
  register: crictl_check
  changed_when: false
  failed_when: false

- name: Check for crictl in common locations
  stat:
    path: "{{ item }}"
  loop:
    - /usr/local/bin/crictl
    - /usr/bin/crictl
  register: crictl_locations
  failed_when: false

- name: Download crictl
  get_url:
    url: "https://github.com/kubernetes-sigs/cri-tools/releases/download/{{ crictl_version | default('v1.34.0') }}/crictl-{{ crictl_version | default('v1.34.0') }}-linux-amd64.tar.gz"
    dest: /tmp/crictl.tar.gz
    mode: '0644'
  when:
    - crictl_check.rc != 0
    - crictl_locations.results | selectattr('stat.exists') | list | length == 0

- name: Extract crictl
  unarchive:
    src: /tmp/crictl.tar.gz
    dest: /usr/local/bin
    remote_src: true
    creates: /usr/local/bin/crictl
  when:
    - crictl_check.rc != 0
    - crictl_locations.results | selectattr('stat.exists') | list | length == 0

- name: Set crictl permissions
  file:
    path: /usr/local/bin/crictl
    mode: '0755'
    owner: root
    group: root
  when:
    - crictl_check.rc != 0
    - crictl_locations.results | selectattr('stat.exists') | list | length == 0

- name: Clean up crictl temporary file
  file:
    path: /tmp/crictl.tar.gz
    state: absent

- name: Check if crictl config exists
  stat:
    path: /etc/crictl.yaml
  register: crictl_config_stat
  failed_when: false

- name: Configure crictl to use containerd socket
  copy:
    dest: /etc/crictl.yaml
    content: |
      runtime-endpoint: unix:///run/containerd/containerd.sock
      image-endpoint: unix:///run/containerd/containerd.sock
      timeout: 10
      debug: false
    mode: '0644'
    owner: root
    group: root
  when: not crictl_config_stat.stat.exists

- name: Ensure kubelet config directory exists
  file:
    path: /var/lib/kubelet
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Configure kubelet extra args
  copy:
    dest: /etc/default/kubelet
    content: |
      KUBELET_EXTRA_ARGS=--container-runtime-endpoint=unix:///run/containerd/containerd.sock --cgroup-driver=systemd
    mode: '0644'
    owner: root
    group: root

- name: Ensure Kubernetes manifests directory exists
  file:
    path: /etc/kubernetes/manifests
    state: directory
    mode: '0755'
    owner: root
    group: root

- name: Configure kubelet
  template:
    src: kubelet-config.yaml.j2
    dest: /var/lib/kubelet/config.yaml
    owner: root
    group: root
    mode: '0600'
  notify: restart kubelet

# CIS 4.1.9 & 4.1.10 - Ensure kubelet config.yaml permissions and ownership
# Note: Permissions and ownership are already set in the template task above
# This task ensures they remain correct even if file is modified elsewhere
- name: Verify kubelet config.yaml permissions and ownership (CIS 4.1.9, 4.1.10)
  file:
    path: /var/lib/kubelet/config.yaml
    mode: '0600'
    owner: root
    group: root

# CIS 4.1.1 & 4.1.2 - Ensure kubelet service file permissions and ownership
- name: Check if kubelet service files exist
  stat:
    path: "{{ item }}"
  register: kubelet_service_files
  loop:
    - /etc/systemd/system/kubelet.service
    - /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
  ignore_errors: true

- name: Set kubelet service file permissions and ownership (CIS 4.1.1, 4.1.2)
  file:
    path: "{{ item.item }}"
    mode: '0600'
    owner: root
    group: root
  loop: "{{ kubelet_service_files.results }}"
  when: item.stat.exists

# CIS 4.1.5 & 4.1.6 - Ensure kubelet.conf file permissions and ownership
- name: Check if kubelet.conf exists
  stat:
    path: /etc/kubernetes/kubelet.conf
  register: kubelet_conf_stat
  ignore_errors: true

- name: Set kubelet.conf file permissions and ownership (CIS 4.1.5, 4.1.6)
  file:
    path: /etc/kubernetes/kubelet.conf
    mode: '0600'
    owner: root
    group: root
  when: kubelet_conf_stat.stat.exists

# CIS 4.1.7 & 4.1.8 - Ensure certificate authorities file permissions and ownership
- name: Check if client CA file exists
  stat:
    path: "{{ kubelet_client_ca_file | default('/etc/kubernetes/pki/ca.crt') }}"
  register: client_ca_file_stat
  ignore_errors: true

- name: Set certificate authorities file permissions and ownership (CIS 4.1.7, 4.1.8)
  file:
    path: "{{ kubelet_client_ca_file | default('/etc/kubernetes/pki/ca.crt') }}"
    mode: '0600'
    owner: root
    group: root
  when: client_ca_file_stat.stat.exists

# CIS 4.2.7 - Ensure hostname-override is not set
- name: Check kubelet service files for hostname-override
  shell: |
    grep -r "hostname-override" /etc/systemd/system/kubelet.service* 2>/dev/null || true
  register: hostname_override_check
  changed_when: false
  failed_when: false

- name: Verify hostname-override is not set (CIS 4.2.7)
  assert:
    that:
      - hostname_override_check.stdout == ""
    fail_msg: "FAIL: hostname-override argument found in kubelet service files (CIS 4.2.7)"
    success_msg: "PASS: hostname-override not set (CIS 4.2.7)"

# CIS 4.1.3 & 4.1.4 - Proxy kubeconfig file permissions and ownership (if exists)
- name: Find proxy kubeconfig files
  find:
    paths:
      - /etc/kubernetes
      - /var/lib/kube-proxy
    patterns:
      - "kube-proxy*.conf"
      - "proxy*.conf"
    file_type: file
  register: proxy_kubeconfig_files
  ignore_errors: true

- name: Set proxy kubeconfig file permissions and ownership (CIS 4.1.3, 4.1.4)
  file:
    path: "{{ item.path }}"
    mode: '0600'
    owner: root
    group: root
  loop: "{{ proxy_kubeconfig_files.files | default([]) }}"
  when: proxy_kubeconfig_files.files is defined and proxy_kubeconfig_files.files | length > 0

# CNI Configuration file security (CIS 4.1.9, 4.1.10 equivalent for CNI)
- name: Find CNI configuration files
  find:
    paths:
      - /etc/cni/net.d
    patterns:
      - "*.conf"
      - "*.conflist"
    file_type: file
  register: cni_config_files
  ignore_errors: true

- name: Set CNI configuration file permissions and ownership
  file:
    path: "{{ item.path }}"
    mode: '0600'
    owner: root
    group: root
  loop: "{{ cni_config_files.files | default([]) }}"
  when: cni_config_files.files is defined and cni_config_files.files | length > 0

# ============================================================================
# KUBELET SERVICE ENABLEMENT
# ============================================================================
- name: Enable kubelet service
  systemd:
    name: kubelet
    enabled: true
    daemon_reload: true
