---
# Pre-join Validation
# Validates prerequisites before joining node

# =============================================================================
# Pre-join checks
# =============================================================================
- name: Check if kubeadm is installed
  ansible.builtin.command:
    cmd: which kubeadm
  register: kubeadm_check
  changed_when: false
  failed_when: false

- name: Fail if kubeadm is not installed
  ansible.builtin.fail:
    msg: "kubeadm is not installed on {{ inventory_hostname }}. Please install it first."
  when: kubeadm_check.rc != 0

- name: Check if node is already part of the cluster
  ansible.builtin.stat:
    path: /etc/kubernetes/kubelet.conf
  register: kubelet_config
  failed_when: false

- name: Skip if node is already joined
  ansible.builtin.debug:
    msg: "Node {{ inventory_hostname }} is already part of the cluster. Skipping join."
  when: skip_if_already_joined and kubelet_config.stat.exists
  changed_when: false

- name: Check if containerd is running
  ansible.builtin.systemd:
    name: containerd
  register: containerd_status
  failed_when: false

- name: Ensure containerd is running
  ansible.builtin.systemd:
    name: containerd
    state: started
    enabled: yes
  when: containerd_status.status.ActiveState != "active"

