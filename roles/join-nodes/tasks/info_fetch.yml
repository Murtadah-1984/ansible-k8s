---
# Join Information Fetching
# Auto-fetches join token and CA cert hash from control plane

# =============================================================================
# Auto-fetch join information (optional)
# =============================================================================
- name: Display join information
  ansible.builtin.debug:
    msg:
      - "======================================================"
      - "  Kubernetes Node Join (kubeadm join)"
      - "======================================================"
      - ""
      - "Target nodes: All nodes EXCEPT control plane"
      - "Control plane nodes will be joined manually"
      - ""
      - "Required variables:"
      - "  - join_token"
      - "  - discovery_token_ca_cert_hash"
      - "  - api_server_endpoint"
      - ""
      - "======================================================"
  run_once: true

- name: Check if kubectl is available for auto-fetch
  ansible.builtin.command:
    cmd: which kubectl
  register: kubectl_check
  when: auto_fetch_join_info
  delegate_to: "{{ control_plane_host }}"
  changed_when: false
  failed_when: false
  run_once: true

- name: Fetch join token from control plane
  ansible.builtin.shell: |
    kubeadm token list -o jsonpath='{.token}' | head -1
  register: fetched_token
  when: auto_fetch_join_info and kubectl_check.rc == 0
  delegate_to: "{{ control_plane_host }}"
  changed_when: false
  no_log: true
  run_once: true

- name: Fetch CA cert hash from control plane
  ansible.builtin.shell: |
    openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | \
    openssl rsa -pubin -outform der 2>/dev/null | \
    openssl dgst -sha256 -hex | sed 's/^.* //'
  register: fetched_ca_hash
  when: auto_fetch_join_info and kubectl_check.rc == 0
  delegate_to: "{{ control_plane_host }}"
  changed_when: false
  no_log: true
  run_once: true

- name: Set join token from fetched value
  ansible.builtin.set_fact:
    join_token: "{{ fetched_token.stdout }}"
  when: auto_fetch_join_info and fetched_token.stdout is defined and join_token == ""
  no_log: true
  run_once: true

- name: Set CA cert hash from fetched value
  ansible.builtin.set_fact:
    discovery_token_ca_cert_hash: "sha256:{{ fetched_ca_hash.stdout }}"
  when: auto_fetch_join_info and fetched_ca_hash.stdout is defined and discovery_token_ca_cert_hash == ""
  no_log: true
  run_once: true

- name: Display fetched join information
  ansible.builtin.debug:
    msg:
      - "Fetched join information:"
      - "  Token: {{ join_token[:10] }}... (truncated for security)"
      - "  CA Hash: {{ discovery_token_ca_cert_hash[:20] }}... (truncated)"
  when: auto_fetch_join_info and fetched_token.stdout is defined
  run_once: true

- name: Validate required variables are set
  ansible.builtin.fail:
    msg: "{{ item }} is required. Set it via -e {{ item }}=value, enable auto_fetch_join_info=true, or set in the playbook vars."
  loop:
    - join_token
    - discovery_token_ca_cert_hash
    - api_server_endpoint
  when: (item == "" or item is not defined) and not (auto_fetch_join_info and item == "api_server_endpoint")
  run_once: true

