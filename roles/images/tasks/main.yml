---
# Images Role - Main Entry Point
# Orchestrates Kubernetes container image pre-loading

# ============================================================================
# PREREQUISITES
# ============================================================================
- name: Check prerequisites
  include_tasks: prerequisites.yml

# ============================================================================
# IMAGE LIST
# ============================================================================
- name: Get Kubernetes image list
  include_tasks: image_list.yml

# ============================================================================
# PRE-LOAD IMAGES
# ============================================================================
- name: Pre-load Kubernetes images
  include_tasks: preload.yml

# ============================================================================
# VERIFICATION
# ============================================================================
- name: Verify images
  include_tasks: verification.yml
  systemd:
    name: containerd
  register: containerd_status
  failed_when: containerd_status.status.ActiveState != 'active'

- name: Verify containerd socket exists
  wait_for:
    path: /run/containerd/containerd.sock
    state: present
    timeout: 30
  register: containerd_socket_check

- name: Check if crictl is available
  command: which crictl
  register: crictl_check
  changed_when: false
  failed_when: false

- name: Fail if crictl is not installed
  fail:
    msg: "crictl is required for image pre-loading. Install it via the kubernetes role first."
  when: crictl_check.rc != 0

- name: Test containerd connectivity with crictl
  command: crictl info
  environment:
    CONTAINER_RUNTIME_ENDPOINT: unix:///run/containerd/containerd.sock
    IMAGE_SERVICE_ENDPOINT: unix:///run/containerd/containerd.sock
  register: crictl_info
  changed_when: false
  retries: 60
  until: crictl_info.rc == 0
  delay: 2
  failed_when: crictl_info.rc != 0

# ============================================================================
# GET KUBERNETES IMAGE LIST
# ============================================================================
- name: Get Kubernetes version for image list
  set_fact:
    k8s_pure_version: "{{ kubernetes_version | default('1.34') }}"

- name: Get list of required Kubernetes images
  block:
    - name: Get images list with specific version
      command: kubeadm config images list --kubernetes-version=v{{ k8s_pure_version }}
      register: k8s_images_versioned
      changed_when: false
      failed_when: false

    - name: Get images list without version (fallback)
      command: kubeadm config images list
      register: k8s_images_default
      changed_when: false
      failed_when: false
      when: k8s_images_versioned.rc != 0

    - name: Set k8s_images fact
      set_fact:
        k8s_images: "{{ k8s_images_versioned if k8s_images_versioned.rc == 0 else k8s_images_default }}"

  rescue:
    - name: Handle image list failure
      fail:
        msg: "Failed to get Kubernetes image list from kubeadm"

- name: Filter out empty lines and warnings from image list
  set_fact:
    k8s_image_list: "{{ k8s_images.stdout_lines | select('match', '^[^W]') | reject('equalto', '') | list }}"

- name: Fail if no images found
  assert:
    that:
      - k8s_image_list | length > 0
    fail_msg: "No images found in kubeadm image list"
    success_msg: "Found {{ k8s_image_list | length }} image(s) to pre-load"

# ============================================================================
# PRE-LOAD IMAGES
# ============================================================================
- name: Pre-load Kubernetes container images
  command: crictl pull "{{ item }}"
  environment:
    CONTAINER_RUNTIME_ENDPOINT: unix:///run/containerd/containerd.sock
    IMAGE_SERVICE_ENDPOINT: unix:///run/containerd/containerd.sock
  loop: "{{ k8s_image_list }}"
  register: image_pull_results
  retries: 3
  delay: 5
  until: image_pull_results.results | selectattr('item', 'equalto', item) | selectattr('rc', 'equalto', 0) | list | length > 0

- name: Check for failed image pulls
  set_fact:
    failed_images: "{{ image_pull_results.results | selectattr('rc', 'ne', 0) | map(attribute='item') | list }}"

- name: Fail if any images failed to pull
  fail:
    msg: "Failed to pre-load {{ failed_images | length }} image(s): {{ failed_images | join(', ') }}"
  when: failed_images | length > 0

- name: Count successfully pulled images
  set_fact:
    pulled_count: "{{ image_pull_results.results | selectattr('rc', 'equalto', 0) | list | length }}"

- name: Display pre-load summary
  debug:
    msg:
      - "Successfully pre-loaded {{ pulled_count }} Kubernetes image(s) for version v{{ k8s_pure_version }}"
      - "Images: {{ k8s_image_list | join(', ') }}"

# ============================================================================
# VERIFICATION
# ============================================================================
- name: Verify images are available in containerd
  command: crictl images
  environment:
    CONTAINER_RUNTIME_ENDPOINT: unix:///run/containerd/containerd.sock
    IMAGE_SERVICE_ENDPOINT: unix:///run/containerd/containerd.sock
  register: crictl_images
  changed_when: false
  failed_when: false

- name: Count verified Kubernetes images
  set_fact:
    verified_count: "{{ (crictl_images.stdout | regex_findall('(k8s\\.gcr\\.io|registry\\.k8s\\.io)') | length) | default(0) }}"

- name: Display verification result
  debug:
    msg: "{{ 'Verified ' + verified_count | string + ' Kubernetes image(s) in containerd storage' if verified_count | int > 0 else 'Could not verify images in containerd storage (this may be normal)' }}"
