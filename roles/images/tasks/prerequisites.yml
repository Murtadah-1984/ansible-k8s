---
# Prerequisites for Image Pre-loading
# Verifies containerd and crictl are available

# ============================================================================
# PREREQUISITE CHECKS
# ============================================================================
- name: Verify containerd service is active
  systemd:
    name: containerd
  register: containerd_status
  failed_when: containerd_status.status.ActiveState != 'active'

- name: Verify containerd socket exists
  wait_for:
    path: /run/containerd/containerd.sock
    state: present
    timeout: 30
  register: containerd_socket_check

- name: Check if crictl is available
  command: which crictl
  register: crictl_check
  changed_when: false
  failed_when: false

- name: Fail if crictl is not installed
  fail:
    msg: "crictl is required for image pre-loading. Install it via the kubernetes role first."
  when: crictl_check.rc != 0

- name: Test containerd connectivity with crictl
  command: crictl info
  environment:
    CONTAINER_RUNTIME_ENDPOINT: unix:///run/containerd/containerd.sock
    IMAGE_SERVICE_ENDPOINT: unix:///run/containerd/containerd.sock
  register: crictl_info
  changed_when: false
  retries: 60
  until: crictl_info.rc == 0
  delay: 2
  failed_when: crictl_info.rc != 0

