---
# Get Kubernetes Image List
# Retrieves list of required Kubernetes images from kubeadm

# ============================================================================
# GET KUBERNETES IMAGE LIST
# ============================================================================
- name: Get Kubernetes version for image list
  set_fact:
    k8s_pure_version: "{{ kubernetes_version | default('1.34') }}"

- name: Get list of required Kubernetes images
  block:
    - name: Get images list with specific version
      command: kubeadm config images list --kubernetes-version=v{{ k8s_pure_version }}
      register: k8s_images_versioned
      changed_when: false
      failed_when: false

    - name: Get images list without version (fallback)
      command: kubeadm config images list
      register: k8s_images_default
      changed_when: false
      failed_when: false
      when: k8s_images_versioned.rc != 0

    - name: Set k8s_images fact
      set_fact:
        k8s_images: "{{ k8s_images_versioned if k8s_images_versioned.rc == 0 else k8s_images_default }}"

  rescue:
    - name: Handle image list failure
      fail:
        msg: "Failed to get Kubernetes image list from kubeadm"

- name: Filter out empty lines and warnings from image list
  set_fact:
    k8s_image_list: "{{ k8s_images.stdout_lines | select('match', '^[^W]') | reject('equalto', '') | list }}"

- name: Fail if no images found
  assert:
    that:
      - k8s_image_list | length > 0
    fail_msg: "No images found in kubeadm image list"
    success_msg: "Found {{ k8s_image_list | length }} image(s) to pre-load"

