---
# Repository Cleanup
# Removes old Kubernetes repository entries

- name: Find Kubernetes repository files to remove
  find:
    paths: /etc/apt/sources.list.d
    patterns:
      - "*kubernetes*"
      - "*k8s*"
    file_type: file
  register: k8s_repo_files
  failed_when: false
  changed_when: false

- name: Remove Kubernetes repository files
  file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ k8s_repo_files.files | default([]) }}"
  failed_when: false

- name: Remove Kubernetes repository lines from sources.list
  lineinfile:
    path: /etc/apt/sources.list
    regexp: 'pkgs\.k8s\.io'
    state: absent
  failed_when: false

- name: Find all files in sources.list.d that might contain Kubernetes repos
  find:
    paths: /etc/apt/sources.list.d
    file_type: file
  register: sources_list_d_files
  failed_when: false
  changed_when: false

- name: Remove Kubernetes repository lines from sources.list.d files
  lineinfile:
    path: "{{ item.path }}"
    regexp: 'pkgs\.k8s\.io'
    state: absent
  loop: "{{ sources_list_d_files.files | default([]) }}"
  failed_when: false

- name: Verify no Kubernetes repository entries remain
  shell: |
    grep -r "pkgs\.k8s\.io" /etc/apt/sources.list /etc/apt/sources.list.d/ 2>/dev/null || echo "No entries found"
  register: k8s_repo_check
  changed_when: false
  failed_when: false

- name: Display remaining Kubernetes repository entries (if any)
  debug:
    msg: "WARNING: Found remaining Kubernetes repository entries: {{ k8s_repo_check.stdout }}"
  when: k8s_repo_check.stdout != "No entries found" and k8s_repo_check.stdout != ""

- name: Clear APT cache after cleanup
  apt:
    update_cache: false
    cache_valid_time: 0
  failed_when: false

