- name: Fail if not Ubuntu 22.04
  assert:
    that:
      - ansible_distribution == "Ubuntu"
      - ansible_distribution_version == "22.04"
    fail_msg: "This role is optimized for Ubuntu 22.04 LTS (detected: {{ ansible_distribution }} {{ ansible_distribution_version }})"

- name: Wait for cloud-init
  command: cloud-init status --wait
  changed_when: false
  failed_when: false

- name: Aggressively remove all Kubernetes repository entries (fix conflicts)
  shell: |
    # Remove all Kubernetes repository files
    rm -f /etc/apt/sources.list.d/*kubernetes* /etc/apt/sources.list.d/*k8s* 2>/dev/null || true
    
    # Remove Kubernetes repository lines from sources.list
    sed -i '/pkgs\.k8s\.io/d' /etc/apt/sources.list 2>/dev/null || true
    
    # Remove any lines containing kubernetes or k8s from all sources.list.d files
    find /etc/apt/sources.list.d -type f -exec sed -i '/pkgs\.k8s\.io/d' {} \; 2>/dev/null || true
  changed_when: false
  failed_when: false

- name: Verify no Kubernetes repository entries remain
  shell: |
    grep -r "pkgs\.k8s\.io" /etc/apt/sources.list /etc/apt/sources.list.d/ 2>/dev/null || echo "No entries found"
  register: k8s_repo_check
  changed_when: false
  failed_when: false

- name: Display remaining Kubernetes repository entries (if any)
  debug:
    msg: "WARNING: Found remaining Kubernetes repository entries: {{ k8s_repo_check.stdout }}"
  when: k8s_repo_check.stdout != "No entries found" and k8s_repo_check.stdout != ""

- name: Clear APT cache after cleanup
  command: apt-get clean
  changed_when: false
  failed_when: false

- name: Install uuid-runtime
  apt:
    name: uuid-runtime
    state: present
    update_cache: true

- name: Install node uniqueness script
  copy:
    src: verify-node-uniqueness.sh
    dest: /usr/local/bin/verify-node-uniqueness.sh
    mode: "0755"
