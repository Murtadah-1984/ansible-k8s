---
# CIS Ubuntu 24.04 LTS STIG Hardening Role
# Implements automated recommendations from CIS Ubuntu Linux 24.04 LTS STIG Benchmark v1.0.0
#
# Prerequisites:
# - Ubuntu 24.04 LTS
# - Root or sudo access
# - Ansible 2.9+
# - common role should run first
#
# Usage:
#   ansible-playbook -i inventory.ini playbook.yml
#
# Variables:
#   - grub_password_hash: GRUB bootloader password hash (default: 'CHANGE_ME')
#   - disable_swap: Disable swap for Kubernetes (default: true)
#   - kubernetes_ports: List of Kubernetes ports to allow through UFW (default: ['10250', '10256', '30000:32767'])

# ============================================================================
# PACKAGE MANAGEMENT
# ============================================================================
- name: Manage packages (removal and installation)
  include_tasks: packages.yml

# ============================================================================
# SYSTEM CONFIGURATION
# ============================================================================
- name: Configure system settings (hostname, postfix)
  include_tasks: system_config.yml

# ============================================================================
# SERVICE CONFIGURATION
# ============================================================================
- name: Configure and manage services
  include_tasks: services.yml

# ============================================================================
# FIREWALL CONFIGURATION
# ============================================================================
- name: Configure UFW firewall
  include_tasks: firewall.yml

# ============================================================================
# FILE INTEGRITY MONITORING
# ============================================================================
- name: Configure AIDE for file integrity monitoring
  include_tasks: aide.yml

# ============================================================================
# SSH CONFIGURATION
# ============================================================================
- name: Configure SSH daemon and client
  include_tasks: ssh.yml

# ============================================================================
# SYSTEM LIMITS AND SESSION MANAGEMENT
# ============================================================================
- name: Configure system limits and session timeouts
  include_tasks: limits.yml

# ============================================================================
# BOOT SECURITY CONFIGURATION
# ============================================================================
- name: Configure GRUB bootloader security
  include_tasks: boot.yml

# ============================================================================
# FILE PERMISSIONS
# ============================================================================
- name: Set correct file permissions
  include_tasks: permissions.yml

# ============================================================================
# PASSWORD POLICY CONFIGURATION
# ============================================================================
- name: Configure password quality requirements
  include_tasks: password.yml

# ============================================================================
# NETWORK SECURITY CONFIGURATION
# ============================================================================
- name: Configure network security parameters
  include_tasks: network.yml

# ============================================================================
# SWAP CONFIGURATION
# ============================================================================
- name: Disable swap for Kubernetes
  include_tasks: swap.yml
  apt:
    name:
      - telnetd
      - rsh-server
    state: absent
    purge: yes

- name: Remove systemd-timesyncd package (UBTU-24-100010)
  apt:
    name: systemd-timesyncd
    state: absent
    purge: yes

- name: Remove ntp package (UBTU-24-100020)
  apt:
    name: ntp
    state: absent
    purge: yes

# ============================================================================
# SYSTEM CONFIGURATION
# ============================================================================

- name: Ensure proper hostname is set
  hostname:
    name: "{{ inventory_hostname }}"
  register: hostname_result

- name: Ensure /etc/hosts has proper entry for hostname resolution
  lineinfile:
    path: /etc/hosts
    regexp: '^127\.0\.0\.1\s+.*{{ inventory_hostname }}'
    line: "127.0.0.1 localhost {{ inventory_hostname }}"
    state: present
  when: hostname_result.changed | default(false)

# ============================================================================
# POSTFIX CONFIGURATION
# ============================================================================
# Configure postfix for local-only delivery to prevent mail relay vulnerabilities
# Pre-configure debconf settings before package installation

- name: Configure postfix for local-only delivery (pre-configure before installation)
  debconf:
    name: postfix
    question: "{{ item.question }}"
    value: "{{ item.value }}"
    vtype: "{{ item.vtype }}"
  loop:
    - { question: 'postfix/main_mailer_type', value: 'local', vtype: 'select' }
    - { question: 'postfix/mailname', value: 'localhost.localdomain', vtype: 'string' }
    - { question: 'postfix/root_address', value: '', vtype: 'string' }
    - { question: 'postfix/destinations', value: 'localhost.localdomain, localhost', vtype: 'string' }
  when: ansible_pkg_mgr == 'apt'
  failed_when: false

- name: Fix existing postfix configuration if present (before package installation)
  block:
    - name: Check if postfix configuration exists
      stat:
        path: /etc/postfix/main.cf
      register: postfix_config_exists

    - name: Fix postfix main.cf for local-only (remove invalid domain)
      lineinfile:
        path: /etc/postfix/main.cf
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        backup: true
      loop:
        - { regexp: '^myhostname\s*=', line: 'myhostname = localhost.localdomain' }
        - { regexp: '^mydomain\s*=', line: 'mydomain = localdomain' }
        - { regexp: '^mydestination\s*=', line: 'mydestination = localhost.localdomain, localhost' }
        - { regexp: '^inet_interfaces\s*=', line: 'inet_interfaces = loopback-only' }
      when: postfix_config_exists.stat.exists

    - name: Remove any lines with invalid IP addresses in postfix config
      lineinfile:
        path: /etc/postfix/main.cf
        regexp: '^mydomain\s*=\s*8\.8\.4\.4'
        line: 'mydomain = localdomain'
        state: present
      when: postfix_config_exists.stat.exists

    - name: Fix invalid domain in postfix config using replace module
      replace:
        path: /etc/postfix/main.cf
        regexp: '^mydomain\s*=\s*8\.8\.4\.4'
        replace: 'mydomain = localdomain'
      when: postfix_config_exists.stat.exists
      failed_when: false

    - name: Fix /etc/mailname if it contains invalid domain
      lineinfile:
        path: /etc/mailname
        line: 'localhost.localdomain'
        regexp: '.*'
        create: true
      when: postfix_config_exists.stat.exists
      failed_when: false

# ============================================================================
# PACKAGE INSTALLATION - SECURITY TOOLS
# ============================================================================
# Install required security packages for CIS STIG compliance

- name: Install required security packages
  apt:
    name:
      - ufw
      - fail2ban
      - unattended-upgrades
      - auditd
      - audispd-plugins
      - libpam-pwquality
      - aide
      - aide-common
      - apparmor
      - apparmor-utils
      - chrony
      - openssh-server
      - openssh-client
      - rsyslog
      - sssd
      - libpam-sss
      - libnss-sss
      - opensc-pkcs11
      - libpam-pkcs11
      - vlock
    state: present
    update_cache: true
  register: apt_install_result
  failed_when: false

- name: Fix postfix configuration (always run after package installation)
  block:
    - name: Check if postfix configuration exists
      stat:
        path: /etc/postfix/main.cf
      register: postfix_config

    - name: Fix postfix main.cf for local-only
      lineinfile:
        path: /etc/postfix/main.cf
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        backup: true
      loop:
        - { regexp: '^myhostname\s*=', line: 'myhostname = localhost.localdomain' }
        - { regexp: '^mydomain\s*=', line: 'mydomain = localdomain' }
        - { regexp: '^mydestination\s*=', line: 'mydestination = localhost.localdomain, localhost' }
        - { regexp: '^inet_interfaces\s*=', line: 'inet_interfaces = loopback-only' }
      when: postfix_config.stat.exists

    - name: Remove any lines with invalid IP addresses in postfix config (recovery)
      lineinfile:
        path: /etc/postfix/main.cf
        regexp: '^mydomain\s*=\s*8\.8\.4\.4'
        line: 'mydomain = localdomain'
        state: present
      when: postfix_config.stat.exists

    # Use replace module instead of sed for idempotency
    - name: Fix invalid domain in postfix config using replace module (recovery)
      replace:
        path: /etc/postfix/main.cf
        regexp: '^mydomain\s*=\s*8\.8\.4\.4'
        replace: 'mydomain = localdomain'
      when: postfix_config.stat.exists
      failed_when: false

    - name: Fix hostname with invalid IP domain using replace module
      replace:
        path: /etc/postfix/main.cf
        regexp: '\.8\.8\.4\.4$'
        replace: '.localdomain'
      when: postfix_config.stat.exists
      failed_when: false

    - name: Fix /etc/mailname
      lineinfile:
        path: /etc/mailname
        line: 'localhost.localdomain'
        regexp: '.*'
        create: true

    # Use postconf to ensure configuration is applied (postconf is idempotent)
    - name: Ensure postfix domain is configured correctly
      command: postconf -e "mydomain=localdomain"
      failed_when: false
      changed_when: false
      when: postfix_config.stat.exists

    - name: Ensure postfix hostname is configured correctly
      command: postconf -e "myhostname=localhost.localdomain"
      failed_when: false
      changed_when: false
      when: postfix_config.stat.exists

    - name: Reconfigure failed packages if needed
      command: dpkg --configure -a
      failed_when: false
      changed_when: false
      register: dpkg_reconfigure

    - name: Verify postfix configuration
      command: postconf mydomain
      register: postfix_mydomain
      changed_when: false
      failed_when: false
      when: postfix_config.stat.exists

    - name: Display postfix domain status for verification
      debug:
        msg: "Postfix mydomain: {{ postfix_mydomain.stdout | default('not set') }}"
      when: 
        - postfix_config.stat.exists
        - postfix_mydomain.rc == 0

# ============================================================================
# SERVICE CONFIGURATION
# ============================================================================
# Enable and start required services per CIS STIG requirements

- name: Enable and start rsyslog service (UBTU-24-100200)
  systemd:
    name: rsyslog
    enabled: true
    state: started

- name: Enable and start auditd service (UBTU-24-100410)
  systemd:
    name: auditd
    enabled: true
    state: started

- name: Enable and start apparmor service (UBTU-24-100510)
  systemd:
    name: apparmor
    enabled: true
    state: started

- name: Enable and start chrony service (UBTU-24-100700)
  systemd:
    name: chronyd
    enabled: true
    state: started

- name: Enable and start SSH service (UBTU-24-100810)
  systemd:
    name: ssh
    enabled: true
    state: started

- name: Enable and start sssd service (UBTU-24-100660)
  systemd:
    name: sssd
    enabled: true
    state: started

- name: Enable UFW firewall (UBTU-24-100310, UBTU-24-100310)
  ufw:
    state: enabled
    policy: deny

- name: Allow SSH through UFW
  ufw:
    rule: allow
    port: "22"
    proto: tcp

- name: Allow Kubernetes ports through UFW firewall
  ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
  loop: "{{ kubernetes_ports | default(['10250', '10256', '30000:32767']) }}"

# ============================================================================
# FILE INTEGRITY MONITORING (AIDE)
# ============================================================================
# Configure AIDE for file integrity monitoring per CIS STIG requirements
# UBTU-24-90890: Protect audit tools with cryptographic mechanisms
# UBTU-24-100110: Initialize AIDE database (Manual, but automated here)
# UBTU-24-100130: Configure AIDE to notify on baseline changes

- name: Configure AIDE to protect audit tools (UBTU-24-90890)
  blockinfile:
    path: /etc/aide/aide.conf
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Audit Tools"
    block: |
      # Audit Tools
      /sbin/auditctl p+i+n+u+g+s+b+acl+xattrs+sha512
      /sbin/auditd p+i+n+u+g+s+b+acl+xattrs+sha512
      /sbin/ausearch p+i+n+u+g+s+b+acl+xattrs+sha512
      /sbin/aureport p+i+n+u+g+s+b+acl+xattrs+sha512
      /sbin/autrace p+i+n+u+g+s+b+acl+xattrs+sha512
      /sbin/augenrules p+i+n+u+g+s+b+acl+xattrs+sha512

- name: Configure AIDE to notify on changes (UBTU-24-100130)
  lineinfile:
    path: /etc/default/aide
    regexp: '^SILENTREPORTS='
    line: 'SILENTREPORTS=no'
    create: true

- name: Initialize AIDE database if not exists (UBTU-24-100110)
  command: aideinit
  args:
    creates: /var/lib/aide/aide.db
  changed_when: false
  failed_when: false

- name: Check if AIDE database exists
  stat:
    path: /var/lib/aide/aide.db
  register: aide_db_exists
  changed_when: false

- name: Check if new AIDE database exists
  stat:
    path: /var/lib/aide/aide.db.new
  register: aide_db_new_exists
  changed_when: false

- name: Copy AIDE database if new one exists (UBTU-24-100110)
  copy:
    src: /var/lib/aide/aide.db.new
    dest: /var/lib/aide/aide.db
    remote_src: true
    owner: root
    group: root
    mode: '0600'
  when: 
    - not aide_db_exists.stat.exists | default(false)
    - aide_db_new_exists.stat.exists | default(false)

# ============================================================================
# SSH CONFIGURATION
# ============================================================================
# Configure SSH daemon and client with FIPS-approved settings
# UBTU-24-100820: FIPS-approved ciphers
# UBTU-24-100830: FIPS-approved MACs
# UBTU-24-100840: FIPS-validated key exchange algorithms
# UBTU-24-100850: SSH client FIPS-approved ciphers
# UBTU-24-100860: SSH client FIPS-approved MACs

- name: Configure SSH daemon with FIPS-approved settings
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    backup: true
  loop:
    - { regexp: '^#?PermitRootLogin', line: 'PermitRootLogin no' }
    - { regexp: '^#?PasswordAuthentication', line: 'PasswordAuthentication no' }
    - { regexp: '^#?X11Forwarding', line: 'X11Forwarding no' }
    - { regexp: '^#?PermitEmptyPasswords', line: 'PermitEmptyPasswords no' }
    - { regexp: '^#?AllowTcpForwarding', line: 'AllowTcpForwarding no' }
    - { regexp: '^#?ClientAliveInterval', line: 'ClientAliveInterval 300' }
    - { regexp: '^#?ClientAliveCountMax', line: 'ClientAliveCountMax 2' }
    - { regexp: '^#?Ciphers', line: 'Ciphers aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes128-ctr' }
    - { regexp: '^#?MACs', line: 'MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,hmac-sha2-512,hmac-sha2-256' }
    - { regexp: '^#?KexAlgorithms', line: 'KexAlgorithms ecdh-sha2-nistp521,ecdh-sha2-nistp384,ecdh-sha2-nistp256,diffie-hellman-group-exchange-sha256,diffie-hellman-group16-sha512,diffie-hellman-group14-sha256' }
  notify: restart_ssh

- name: Configure SSH client with FIPS-approved settings (UBTU-24-100850, UBTU-24-100860)
  lineinfile:
    path: /etc/ssh/ssh_config
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    backup: true
  loop:
    - { regexp: '^#?Ciphers', line: 'Ciphers aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes128-ctr' }
    - { regexp: '^#?MACs', line: 'MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,hmac-sha2-512,hmac-sha2-256' }

# ============================================================================
# SYSTEM LIMITS AND SESSION MANAGEMENT
# ============================================================================
# Configure system limits and session timeouts per CIS STIG requirements
# UBTU-24-200000: Limit concurrent sessions
# UBTU-24-200060: Configure session timeout

- name: Configure system limits - maxlogins (UBTU-24-200000)
  lineinfile:
    path: /etc/security/limits.conf
    regexp: '^\*\s+hard\s+maxlogins'
    line: '* hard maxlogins 10'
    create: true

- name: Configure session timeout (UBTU-24-200060)
  copy:
    dest: /etc/profile.d/99-terminal_tmout.sh
    content: |
      # CIS STIG UBTU-24-200060: Configure session timeout
      TMOUT=600
      export TMOUT
    mode: '0644'

# ============================================================================
# BOOT SECURITY CONFIGURATION
# ============================================================================
# Configure GRUB bootloader security per CIS STIG requirements
# UBTU-24-102000: GRUB boot password requirement
# UBTU-24-102010: Enable audit at system startup

- name: Configure GRUB boot password requirement (UBTU-24-102000)
  blockinfile:
    path: /etc/grub.d/40_custom
    marker: "# {mark} ANSIBLE MANAGED BLOCK - GRUB Password"
    block: |
      set superusers="root"
      password_pbkdf2 root {{ grub_password_hash | default('CHANGE_ME') }}
    create: true
  when: grub_password_hash is defined and grub_password_hash != 'CHANGE_ME'

- name: Configure GRUB to enable audit at startup (UBTU-24-102010)
  lineinfile:
    path: /etc/default/grub
    regexp: '^GRUB_CMDLINE_LINUX='
    line: 'GRUB_CMDLINE_LINUX="audit=1"'
    backup: true

- name: Update GRUB configuration after changes
  command: update-grub
  changed_when: true
  when: 
    - grub_password_hash is defined
    - grub_password_hash != 'CHANGE_ME'

# ============================================================================
# FILE PERMISSIONS
# ============================================================================
# Set correct file permissions per CIS STIG UBTU-24-400000 series

- name: Set correct file permissions (UBTU-24-400000 series)
  file:
    path: "{{ item.path }}"
    mode: "{{ item.mode }}"
    owner: "{{ item.owner | default('root') }}"
    group: "{{ item.group | default('root') }}"
  loop:
    - { path: /etc/passwd, mode: '0644', owner: root, group: root }
    - { path: /etc/shadow, mode: '0640', owner: root, group: shadow }
    - { path: /etc/group, mode: '0644', owner: root, group: root }
    - { path: /etc/gshadow, mode: '0640', owner: root, group: shadow }
    - { path: /etc/ssh/sshd_config, mode: '0600', owner: root, group: root }

# ============================================================================
# SERVICE DISABLING
# ============================================================================
# Disable unnecessary services to reduce attack surface

- name: Disable unnecessary services
  systemd:
    name: "{{ item }}"
    enabled: false
    state: stopped
  loop:
    - snapd
    - bluetooth
    - avahi-daemon
  ignore_errors: true

# ============================================================================
# PASSWORD POLICY CONFIGURATION
# ============================================================================
# Configure password quality requirements per CIS STIG UBTU-24-100600

- name: Configure password quality (UBTU-24-100600)
  lineinfile:
    path: /etc/security/pwquality.conf
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    create: true
  loop:
    - { regexp: '^#?minlen', line: 'minlen = 14' }
    - { regexp: '^#?dcredit', line: 'dcredit = -1' }
    - { regexp: '^#?ucredit', line: 'ucredit = -1' }
    - { regexp: '^#?ocredit', line: 'ocredit = -1' }
    - { regexp: '^#?lcredit', line: 'lcredit = -1' }

- name: Configure PAM password quality
  lineinfile:
    path: /etc/pam.d/common-password
    regexp: '^password\s+requisite\s+pam_pwquality\.so'
    line: 'password requisite pam_pwquality.so retry=3'
    insertafter: '^password.*pam_unix\.so'
    create: true

# ============================================================================
# NETWORK SECURITY CONFIGURATION
# ============================================================================
# Configure network security parameters via sysctl per CIS STIG requirements

- name: Configure sysctl network security settings
  sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    sysctl_set: true
    reload: true
  loop:
    - { key: 'net.ipv4.conf.all.rp_filter', value: '1' }
    - { key: 'net.ipv4.conf.default.rp_filter', value: '1' }
    - { key: 'net.ipv4.conf.all.accept_redirects', value: '0' }
    - { key: 'net.ipv4.conf.default.accept_redirects', value: '0' }
    - { key: 'net.ipv4.conf.all.secure_redirects', value: '0' }
    - { key: 'net.ipv4.conf.default.secure_redirects', value: '0' }
    - { key: 'net.ipv6.conf.all.accept_redirects', value: '0' }
    - { key: 'net.ipv6.conf.default.accept_redirects', value: '0' }
    - { key: 'net.ipv4.conf.all.send_redirects', value: '0' }
    - { key: 'net.ipv4.conf.default.send_redirects', value: '0' }
    - { key: 'net.ipv4.conf.all.log_martians', value: '1' }
    - { key: 'net.ipv4.conf.default.log_martians', value: '1' }
    - { key: 'net.ipv4.icmp_echo_ignore_broadcasts', value: '1' }
    - { key: 'net.ipv4.tcp_syncookies', value: '1' }
    - { key: 'net.ipv4.conf.all.accept_source_route', value: '0' }
    - { key: 'net.ipv4.conf.default.accept_source_route', value: '0' }
    - { key: 'net.ipv6.conf.all.accept_source_route', value: '0' }
    - { key: 'net.ipv6.conf.default.accept_source_route', value: '0' }

- name: Make sysctl settings persistent
  copy:
    dest: /etc/sysctl.d/99-cis-hardening.conf
    content: |
      # CIS Ubuntu 24.04 LTS STIG Network Security Settings
      net.ipv4.conf.all.rp_filter = 1
      net.ipv4.conf.default.rp_filter = 1
      net.ipv4.conf.all.accept_redirects = 0
      net.ipv4.conf.default.accept_redirects = 0
      net.ipv4.conf.all.secure_redirects = 0
      net.ipv4.conf.default.secure_redirects = 0
      net.ipv6.conf.all.accept_redirects = 0
      net.ipv6.conf.default.accept_redirects = 0
      net.ipv4.conf.all.send_redirects = 0
      net.ipv4.conf.default.send_redirects = 0
      net.ipv4.conf.all.log_martians = 1
      net.ipv4.conf.default.log_martians = 1
      net.ipv4.icmp_echo_ignore_broadcasts = 1
      net.ipv4.tcp_syncookies = 1
      net.ipv4.conf.all.accept_source_route = 0
      net.ipv4.conf.default.accept_source_route = 0
      net.ipv6.conf.all.accept_source_route = 0
      net.ipv6.conf.default.accept_source_route = 0
    mode: '0644'

# ============================================================================
# SWAP CONFIGURATION
# ============================================================================
# Disable swap for Kubernetes compatibility (required for kubelet)

- name: Disable swap (if not needed for Kubernetes)
  command: swapoff -a
  when: disable_swap | default(true)
  changed_when: true
  failed_when: false

- name: Comment out swap entries in /etc/fstab
  replace:
    path: /etc/fstab
    regexp: '^([^#].*?\sswap\s)'
    replace: '#\1'
  when: disable_swap | default(true)
