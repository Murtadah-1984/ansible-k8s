---
# CIS Ubuntu 24.04 LTS STIG Compliance Audit
# Checks compliance with CIS Ubuntu Linux 24.04 LTS STIG Benchmark v1.0.0

- name: OS Version Check
  ansible.builtin.debug:
    msg: "Detected: {{ ansible_facts['distribution'] }} {{ ansible_facts['distribution_version'] }} ({{ ansible_facts['distribution_release'] }})"

- name: PASS/WARN OS target check
  ansible.builtin.debug:
    msg: >-
      {{ 'PASS: Ubuntu 24.04 (target platform)' 
         if (ansible_facts['distribution'] == 'Ubuntu' and ansible_facts['distribution_version'] == '24.04')
         else 'FAIL: Not Ubuntu 24.04; baseline may differ.' }}

- name: Check for prohibited packages (UBTU-24-100030, UBTU-24-100040)
  ansible.builtin.command: dpkg -l | grep -E "^(ii|hi)" | grep -E "(telnetd|rsh-server)"
  register: prohibited_packages
  changed_when: false
  failed_when: false

- name: Prohibited packages result
  ansible.builtin.debug:
    msg: "{{ 'FAIL: Prohibited packages found' if prohibited_packages.rc == 0 else 'PASS: No prohibited packages installed' }}"

- name: Check systemd-timesyncd removal (UBTU-24-100010)
  ansible.builtin.command: dpkg -l | grep systemd-timesyncd
  register: systemd_timesyncd
  changed_when: false
  failed_when: false

- name: systemd-timesyncd result
  ansible.builtin.debug:
    msg: "{{ 'FAIL: systemd-timesyncd is installed' if systemd_timesyncd.rc == 0 else 'PASS: systemd-timesyncd is not installed' }}"

- name: Check ntp removal (UBTU-24-100020)
  ansible.builtin.command: dpkg -l | grep "^ii.*ntp "
  register: ntp_package
  changed_when: false
  failed_when: false

- name: ntp package result
  ansible.builtin.debug:
    msg: "{{ 'FAIL: ntp package is installed' if ntp_package.rc == 0 else 'PASS: ntp package is not installed' }}"

- name: Firewall (UFW) status (UBTU-24-100310, UBTU-24-100310)
  ansible.builtin.command: ufw status verbose
  register: ufw_status
  changed_when: false
  failed_when: false

- name: UFW checks
  ansible.builtin.debug:
    msg:
      - "{{ 'PASS: UFW installed' if ufw_status.rc == 0 else 'FAIL: ufw not installed or not usable' }}"
      - "{{ 'PASS: UFW active' if (ufw_status.stdout is search('Status: active')) else 'FAIL: UFW not active' }}"
      - "{{ 'PASS: Default incoming deny' if (ufw_status.stdout is search('Default: deny \\(incoming\\)')) else 'WARN: Default incoming not deny' }}"

- name: Check required packages installation
  ansible.builtin.command: dpkg -l | grep "{{ item }}"
  loop:
    - "^ii.*aide"
    - "^ii.*auditd"
    - "^ii.*apparmor"
    - "^ii.*chrony"
    - "^ii.*openssh-server"
    - "^ii.*rsyslog"
    - "^ii.*ufw"
    - "^ii.*libpam-pwquality"
  register: required_packages
  changed_when: false
  failed_when: false

- name: Required packages results
  ansible.builtin.debug:
    msg: >-
      {{ 'PASS: ' ~ item.item ~ ' is installed' 
         if (item.rc == 0)
         else 'FAIL: ' ~ item.item ~ ' is not installed' }}
  loop: "{{ required_packages.results }}"

- name: Service status checks
  ansible.builtin.command: systemctl is-active {{ item }}
  loop:
    - rsyslog
    - auditd
    - apparmor
    - chronyd
    - ssh
    - ufw
  register: service_status
  changed_when: false
  failed_when: false

- name: Service status results
  ansible.builtin.debug:
    msg: >-
      {{ 'PASS: ' ~ item.item ~ ' is active' 
         if (item.stdout | trim == 'active')
         else 'FAIL: ' ~ item.item ~ ' is not active (' ~ (item.stdout | trim | default('unknown')) ~ ')' }}
  loop: "{{ service_status.results }}"

- name: SSH hardening checks (read sshd_config)
  ansible.builtin.slurp:
    src: /etc/ssh/sshd_config
  register: sshd_cfg
  failed_when: false

- name: SSH checks output
  ansible.builtin.debug:
    msg:
      - "{{ 'FAIL: /etc/ssh/sshd_config missing' if (sshd_cfg is failed) else 'PASS: sshd_config exists' }}"
      - "{{ 'PASS: PermitRootLogin no' if (sshd_cfg.content | b64decode is search('(?im)^\\s*PermitRootLogin\\s+no\\s*$')) else 'FAIL: PermitRootLogin not no' }}"
      - "{{ 'PASS: PermitEmptyPasswords no' if (sshd_cfg.content | b64decode is search('(?im)^\\s*PermitEmptyPasswords\\s+no\\s*$')) else 'FAIL: PermitEmptyPasswords not no' }}"
      - "{{ 'PASS: X11Forwarding no' if (sshd_cfg.content | b64decode is search('(?im)^\\s*X11Forwarding\\s+no\\s*$')) else 'WARN: X11Forwarding not explicitly no' }}"
      - "{{ 'PASS: AllowTcpForwarding no' if (sshd_cfg.content | b64decode is search('(?im)^\\s*AllowTcpForwarding\\s+no\\s*$')) else 'WARN: AllowTcpForwarding not no' }}"
      - "{{ 'PASS: ClientAliveInterval 300' if (sshd_cfg.content | b64decode is search('(?im)^\\s*ClientAliveInterval\\s+300\\s*$')) else 'WARN: ClientAliveInterval not 300' }}"
      - "{{ 'PASS: ClientAliveCountMax 2' if (sshd_cfg.content | b64decode is search('(?im)^\\s*ClientAliveCountMax\\s+2\\s*$')) else 'WARN: ClientAliveCountMax not 2' }}"
      - "{{ 'PASS: FIPS Ciphers configured' if (sshd_cfg.content | b64decode is search('(?im)^\\s*Ciphers\\s+aes256-gcm@openssh\\.com')) else 'FAIL: FIPS Ciphers not configured' }}"
      - "{{ 'PASS: FIPS MACs configured' if (sshd_cfg.content | b64decode is search('(?im)^\\s*MACs\\s+hmac-sha2-512-etm@openssh\\.com')) else 'FAIL: FIPS MACs not configured' }}"
      - "{{ 'PASS: FIPS KexAlgorithms configured' if (sshd_cfg.content | b64decode is search('(?im)^\\s*KexAlgorithms\\s+ecdh-sha2-nistp521')) else 'FAIL: FIPS KexAlgorithms not configured' }}"

- name: Swap check
  ansible.builtin.command: swapon --show
  register: swap_out
  changed_when: false

- name: Swap result
  ansible.builtin.debug:
    msg: "{{ 'PASS: No active swap devices' if (swap_out.stdout | trim) == '' else 'WARN: Swap is enabled' }}"

- name: Sysctl checks
  ansible.builtin.command: "sysctl -n {{ item.key }}"
  loop:
    - { key: 'net.ipv4.conf.all.rp_filter' }
    - { key: 'net.ipv4.conf.default.rp_filter' }
    - { key: 'net.ipv4.conf.all.accept_redirects' }
    - { key: 'net.ipv4.conf.default.accept_redirects' }
    - { key: 'net.ipv4.conf.all.secure_redirects' }
    - { key: 'net.ipv4.conf.default.secure_redirects' }
    - { key: 'net.ipv6.conf.all.accept_redirects' }
    - { key: 'net.ipv6.conf.default.accept_redirects' }
    - { key: 'net.ipv4.conf.all.send_redirects' }
    - { key: 'net.ipv4.conf.default.send_redirects' }
    - { key: 'net.ipv4.conf.all.log_martians' }
    - { key: 'net.ipv4.conf.default.log_martians' }
    - { key: 'net.ipv4.icmp_echo_ignore_broadcasts' }
    - { key: 'net.ipv4.tcp_syncookies' }
    - { key: 'net.ipv4.conf.all.accept_source_route' }
    - { key: 'net.ipv4.conf.default.accept_source_route' }
    - { key: 'net.ipv6.conf.all.accept_source_route' }
    - { key: 'net.ipv6.conf.default.accept_source_route' }
  register: sysctl_results
  changed_when: false
  failed_when: false

- name: Expected sysctl values
  set_fact:
    expected_sysctl:
      net.ipv4.conf.all.rp_filter: "1"
      net.ipv4.conf.default.rp_filter: "1"
      net.ipv4.conf.all.accept_redirects: "0"
      net.ipv4.conf.default.accept_redirects: "0"
      net.ipv4.conf.all.secure_redirects: "0"
      net.ipv4.conf.default.secure_redirects: "0"
      net.ipv6.conf.all.accept_redirects: "0"
      net.ipv6.conf.default.accept_redirects: "0"
      net.ipv4.conf.all.send_redirects: "0"
      net.ipv4.conf.default.send_redirects: "0"
      net.ipv4.conf.all.log_martians: "1"
      net.ipv4.conf.default.log_martians: "1"
      net.ipv4.icmp_echo_ignore_broadcasts: "1"
      net.ipv4.tcp_syncookies: "1"
      net.ipv4.conf.all.accept_source_route: "0"
      net.ipv4.conf.default.accept_source_route: "0"
      net.ipv6.conf.all.accept_source_route: "0"
      net.ipv6.conf.default.accept_source_route: "0"

- name: Sysctl results output
  ansible.builtin.debug:
    msg: >-
      {{ ('PASS: ' ~ item.item.key ~ ' = ' ~ (item.stdout | trim))
         if ((item.stdout | trim) == (expected_sysctl[item.item.key]))
         else ('FAIL: ' ~ item.item.key ~ ' = ' ~ (item.stdout | trim) ~ ' (expected ' ~ expected_sysctl[item.item.key] ~ ')') }}
  loop: "{{ sysctl_results.results }}"

- name: File permission checks
  ansible.builtin.stat:
    path: "{{ item.path }}"
  loop:
    - { path: /etc/passwd, mode: "0644" }
    - { path: /etc/shadow, mode: "0640" }
    - { path: /etc/group, mode: "0644" }
    - { path: /etc/gshadow, mode: "0640" }
  register: perm_stats

- name: Permission results output
  ansible.builtin.debug:
    msg: >-
      {{ 'PASS: ' ~ item.item.path ~ ' mode ' ~ item.stat.mode
         if (item.stat.exists and item.stat.mode == item.item.mode)
         else ('FAIL: ' ~ item.item.path ~ ' mode ' ~ (item.stat.mode | default('MISSING')) ~ ' (expected ' ~ item.item.mode ~ ')') }}
  loop: "{{ perm_stats.results }}"

- name: Service disabled checks (snapd, bluetooth, avahi)
  ansible.builtin.command: "systemctl is-enabled {{ item }}"
  loop:
    - snapd.service
    - bluetooth.service
    - avahi-daemon.service
  register: svc_enabled
  changed_when: false
  failed_when: false

- name: Service results output
  ansible.builtin.debug:
    msg: >-
      {{ 'PASS: ' ~ item.item ~ ' is ' ~ item.stdout
         if (item.rc == 0 and (item.stdout | trim) in ['disabled','masked'])
         else ('WARN: ' ~ item.item ~ ' is ' ~ (item.stdout | trim | default('not-installed/unknown'))) }}
  loop: "{{ svc_enabled.results }}"

- name: Auditd checks
  ansible.builtin.command: auditctl -l
  register: audit_rules
  changed_when: false
  failed_when: false

- name: Auditd service state
  ansible.builtin.command: systemctl is-active auditd
  register: auditd_state
  changed_when: false
  failed_when: false

- name: Auditd output
  ansible.builtin.debug:
    msg:
      - "{{ 'FAIL: auditd not installed (auditctl missing)' if audit_rules.rc != 0 else 'PASS: auditctl available' }}"
      - "{{ 'PASS: auditd active' if (auditd_state.stdout | trim) == 'active' else 'FAIL: auditd not active' }}"
      - "{{ 'PASS: audit rules present' if (audit_rules.stdout | trim) != '' else 'WARN: no audit rules configured' }}"

- name: Time synchronization check
  ansible.builtin.command: systemctl is-active chronyd
  register: chronyd_state
  changed_when: false
  failed_when: false

- name: Time sync output
  ansible.builtin.debug:
    msg: >-
      {{ 'PASS: chronyd active' if (chronyd_state.stdout | trim) == 'active'
         else ('FAIL: chronyd state=' ~ (chronyd_state.stdout | trim)) }}

- name: Password policy check (UBTU-24-100600)
  ansible.builtin.command: grep -q "pam_pwquality.so" /etc/pam.d/common-password
  register: pwq
  changed_when: false
  failed_when: false

- name: Password policy output
  ansible.builtin.debug:
    msg: "{{ 'PASS: pam_pwquality is configured' if pwq.rc == 0 else 'FAIL: pam_pwquality not found in common-password' }}"

- name: Check AIDE installation and configuration (UBTU-24-100100, UBTU-24-90890)
  ansible.builtin.command: dpkg -l | grep "^ii.*aide"
  register: aide_installed
  changed_when: false
  failed_when: false

- name: Check AIDE database exists
  ansible.builtin.stat:
    path: /var/lib/aide/aide.db
  register: aide_db

- name: Check AIDE configuration for audit tools
  ansible.builtin.command: grep -E "(\/sbin\/(audit|au))" /etc/aide/aide.conf
  register: aide_audit_tools
  changed_when: false
  failed_when: false

- name: AIDE results
  ansible.builtin.debug:
    msg:
      - "{{ 'PASS: AIDE is installed' if aide_installed.rc == 0 else 'FAIL: AIDE is not installed' }}"
      - "{{ 'PASS: AIDE database exists' if aide_db.stat.exists else 'WARN: AIDE database does not exist (run aideinit)' }}"
      - "{{ 'PASS: AIDE audit tools configured' if aide_audit_tools.rc == 0 else 'FAIL: AIDE audit tools not configured' }}"

- name: Check AIDE silent reports setting (UBTU-24-100130)
  ansible.builtin.command: grep "^SILENTREPORTS=no" /etc/default/aide
  register: aide_silent
  changed_when: false
  failed_when: false

- name: AIDE silent reports result
  ansible.builtin.debug:
    msg: "{{ 'PASS: AIDE SILENTREPORTS=no' if aide_silent.rc == 0 else 'FAIL: AIDE SILENTREPORTS not set to no' }}"

- name: Check system limits maxlogins (UBTU-24-200000)
  ansible.builtin.command: grep "maxlogins" /etc/security/limits.conf
  register: maxlogins
  changed_when: false
  failed_when: false

- name: Maxlogins result
  ansible.builtin.debug:
    msg: "{{ 'PASS: maxlogins configured' if (maxlogins.rc == 0 and 'maxlogins 10' in maxlogins.stdout) else 'FAIL: maxlogins not configured to 10' }}"

- name: Check session timeout (UBTU-24-200060)
  ansible.builtin.command: grep "TMOUT=600" /etc/profile.d/*.sh
  register: tmout
  changed_when: false
  failed_when: false

- name: Session timeout result
  ansible.builtin.debug:
    msg: "{{ 'PASS: TMOUT=600 configured' if tmout.rc == 0 else 'FAIL: TMOUT not configured to 600' }}"

- name: Check GRUB audit=1 (UBTU-24-102010)
  ansible.builtin.command: grep "^\s*linux" /boot/grub/grub.cfg | grep -v "audit=1"
  register: grub_audit
  changed_when: false
  failed_when: false

- name: GRUB audit result
  ansible.builtin.debug:
    msg: "{{ 'FAIL: Some GRUB entries missing audit=1' if grub_audit.rc == 0 else 'PASS: All GRUB entries have audit=1' }}"

- name: Check AppArmor status (UBTU-24-100510)
  ansible.builtin.command: systemctl is-active apparmor
  register: apparmor_active
  changed_when: false
  failed_when: false

- name: AppArmor result
  ansible.builtin.debug:
    msg: "{{ 'PASS: AppArmor is active' if (apparmor_active.stdout | trim) == 'active' else 'FAIL: AppArmor is not active' }}"
