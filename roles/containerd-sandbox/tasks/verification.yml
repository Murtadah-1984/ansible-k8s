---
# Verification
# Verifies containerd is running and sandbox image is accessible

- name: Wait for containerd to be ready after handler
  wait_for:
    path: /run/containerd/containerd.sock
    state: present
    timeout: 30
  when: sandbox_image_set.changed | default(false) or systemd_cgroup_set.changed | default(false) or systemd_cgroup_added.changed | default(false)

- name: Verify containerd is running
  systemd:
    name: containerd
  register: containerd_status

- name: Verify sandbox image is accessible
  command: crictl pull {{ sandbox_image }}
  register: sandbox_image_pull
  changed_when: false
  failed_when: false
  when: "'crictl' in ansible_facts.get('packages', {})"

- name: Display sandbox image verification
  debug:
    msg: "Sandbox image {{ sandbox_image }}: {{ 'ACCESSIBLE' if (sandbox_image_pull.rc == 0) else 'VERIFY MANUALLY (crictl may not be installed)' }}"
  when: "'crictl' in ansible_facts.get('packages', {})"

- name: Display completion message
  debug:
    msg:
      - ""
      - "=== Containerd Sandbox Image Fix Completed ==="
      - "Host: {{ inventory_hostname }}"
      - "Config file: {{ containerd_config_path }}"
      - "Sandbox image: {{ sandbox_image }}"
      - "SystemdCgroup: ENABLED"
      - "Containerd status: {{ 'RUNNING' if containerd_status.status.ActiveState == 'active' else 'CHECK MANUALLY' }}"
      - ""
      - "Next steps:"
      - "  1. Verify: sudo crictl pull {{ sandbox_image }}"
      - "  2. Test: sudo kubeadm config images pull --kubernetes-version v{{ kubernetes_version }}"
      - "  3. Retry: sudo kubeadm init (if applicable)"
      - ""

