---
# SSH Key Role - Main Entry Point
# Orchestrates SSH public key deployment

# ============================================================================
# KEY READING
# ============================================================================
- name: Read SSH public key
  include_tasks: key_read.yml

# ============================================================================
# KEY DEPLOYMENT
# ============================================================================
- name: Deploy SSH public key
  include_tasks: key_deploy.yml
  set_fact:
    ssh_key_path: "{{ lookup('env', 'HOME') }}/.ssh/id_ed25519.pub"
  delegate_to: localhost
  become: false
  run_once: true

- name: Read SSH public key from control node
  slurp:
    src: "{{ ssh_key_path }}"
  delegate_to: localhost
  become: false
  run_once: true
  register: ssh_key_file
  failed_when: false

- name: Fail if SSH key file not found
  fail:
    msg: "SSH public key not found at {{ ssh_key_path }}. Please ensure the key exists on the control node."
  when: not ssh_key_file.content is defined
  run_once: true

- name: Decode SSH public key content
  set_fact:
    ssh_public_key: "{{ ssh_key_file.content | b64decode }}"
  run_once: true
  when: ssh_key_file.content is defined

- name: Ensure .ssh directory exists with correct permissions
  file:
    path: "/home/{{ ansible_user }}/.ssh"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0700'
  when: ssh_public_key is defined

- name: Copy public key to authorized_keys
  authorized_key:
    user: "{{ ansible_user }}"
    state: present
    key: "{{ ssh_public_key }}"
    path: "/home/{{ ansible_user }}/.ssh/authorized_keys"
    manage_dir: false
  when: ssh_public_key is defined

