---
# Scan Kubelet Configurations for Misconfigurations
# Simplified version - full scan functionality available in original playbook

- name: Check if kubelet config file exists
  stat:
    path: "{{ kubelet_config_path }}"
  register: kubelet_config_stat
  failed_when: false

- name: Display scan header
  debug:
    msg: "=== Scanning kubelet config on {{ inventory_hostname }} ==="
  when: kubelet_config_stat.stat.exists

- name: Fail if kubelet config file does not exist
  fail:
    msg: "Kubelet config file not found at {{ kubelet_config_path }}"
  when: not kubelet_config_stat.stat.exists

- name: Check file permissions and ownership
  stat:
    path: "{{ kubelet_config_path }}"
  register: kubelet_config_perms
  when: check_permissions | default(true)

- name: Report permission issues
  debug:
    msg:
      - "PERMISSION CHECK:"
      - "  Path: {{ kubelet_config_path }}"
      - "  Mode: {{ '%04o' | format(kubelet_config_perms.stat.mode | int) }}"
      - "  Owner: {{ kubelet_config_perms.stat.pw_name }}"
      - "  Group: {{ kubelet_config_perms.stat.gr_name }}"
      - "  Expected Mode: 0600"
      - "  Expected Owner: root"
      - "  Expected Group: root"
      - "  Status: {{ 'PASS' if (kubelet_config_perms.stat.mode | int) == 33152 and kubelet_config_perms.stat.pw_name == 'root' and kubelet_config_perms.stat.gr_name == 'root' else 'FAIL' }}"
  when: check_permissions | default(true)

- name: Validate YAML syntax
  command: python3 -c "import yaml; yaml.safe_load(open('{{ kubelet_config_path }}'))"
  register: yaml_validation
  changed_when: false
  failed_when: false
  when: check_yaml_syntax | default(true)

- name: Report YAML syntax errors
  debug:
    msg:
      - "YAML SYNTAX CHECK:"
      - "  Status: {{ 'FAIL' if yaml_validation.rc != 0 else 'PASS' }}"
      - "  Error: {{ yaml_validation.stderr if yaml_validation.rc != 0 else 'No errors' }}"
  when: check_yaml_syntax | default(true)

- name: Display summary
  debug:
    msg:
      - ""
      - "=== SCAN SUMMARY FOR {{ inventory_hostname }} ==="
      - "Config file exists: {{ kubelet_config_stat.stat.exists }}"
      - "YAML syntax valid: {{ 'PASS' if yaml_validation.rc == 0 else 'FAIL' }}"
      - "Permissions correct: {{ 'PASS' if (kubelet_config_perms.stat.mode | int) == 33152 and kubelet_config_perms.stat.pw_name == 'root' and kubelet_config_perms.stat.gr_name == 'root' else 'FAIL' }}"
      - ""

