---
# Download Ubuntu netboot files directly (more efficient than ISO)

# ============================================================================
# PREREQUISITE CHECKS
# ============================================================================
- name: Check if Ubuntu kernel and initrd already exist
  stat:
    path: "{{ tftp_root }}/ubuntu/{{ item }}"
  register: ubuntu_files
  loop:
    - vmlinuz
    - initrd.gz
  changed_when: false

- name: Check if all Ubuntu files exist
  set_fact:
    ubuntu_files_exist: "{{ ubuntu_files.results | selectattr('stat.exists') | list | length == 2 }}"

# ============================================================================
# DIRECTORY SETUP
# ============================================================================
- name: Ensure Ubuntu directory exists
  file:
    path: "{{ tftp_root }}/ubuntu"
    state: directory
    mode: '0755'
    owner: root
    group: root
  when: not ubuntu_files_exist

# ============================================================================
# DOWNLOAD NETBOOT FILES
# ============================================================================
# Download directly from Ubuntu's netboot server (more reliable than ISO)
# Try multiple URL patterns to find the correct one
- name: Download Ubuntu kernel (try multiple URLs)
  block:
    - name: Try primary URL (legacy-images)
      get_url:
        url: "{{ ubuntu_netboot_base_url }}/linux"
        dest: "{{ tftp_root }}/ubuntu/vmlinuz"
        mode: '0644'
        owner: root
        group: root
        timeout: 300
      register: kernel_download
      failed_when: false

    - name: Try alternative URL (legacy-images)
      get_url:
        url: "https://archive.ubuntu.com/ubuntu/dists/jammy/main/installer-{{ ubuntu_arch }}/current/legacy-images/netboot/ubuntu-installer/{{ ubuntu_arch }}/linux"
        dest: "{{ tftp_root }}/ubuntu/vmlinuz"
        mode: '0644'
        owner: root
        group: root
        timeout: 300
      when: kernel_download.failed | default(false)
      register: kernel_download_alt1
      failed_when: false

    - name: Try alternative URL (cdimage)
      get_url:
        url: "https://cdimage.ubuntu.com/netboot/{{ ubuntu_version }}/linux"
        dest: "{{ tftp_root }}/ubuntu/vmlinuz"
        mode: '0644'
        owner: root
        group: root
        timeout: 300
      when: 
        - kernel_download.failed | default(false)
        - kernel_download_alt1.failed | default(false)
      register: kernel_download_alt2
      failed_when: false

    - name: Fail if all kernel download attempts failed
      fail:
        msg: |
          Failed to download Ubuntu kernel from all attempted URLs:
          - {{ ubuntu_netboot_base_url }}/linux
          - https://archive.ubuntu.com/ubuntu/dists/jammy/main/installer-{{ ubuntu_arch }}/current/legacy-images/netboot/ubuntu-installer/{{ ubuntu_arch }}/linux
          - https://cdimage.ubuntu.com/netboot/{{ ubuntu_version }}/linux
          
          Please check network connectivity or manually specify a working URL via ubuntu_netboot_base_url variable.
      when:
        - kernel_download.failed | default(false)
        - kernel_download_alt1.failed | default(false)
        - kernel_download_alt2.failed | default(false)
  when: not ubuntu_files_exist

- name: Download Ubuntu initrd (try multiple URLs)
  block:
    - name: Try primary URL (legacy-images)
      get_url:
        url: "{{ ubuntu_netboot_base_url }}/initrd.gz"
        dest: "{{ tftp_root }}/ubuntu/initrd.gz"
        mode: '0644'
        owner: root
        group: root
        timeout: 300
      register: initrd_download
      failed_when: false

    - name: Try alternative URL (legacy-images)
      get_url:
        url: "https://archive.ubuntu.com/ubuntu/dists/jammy/main/installer-{{ ubuntu_arch }}/current/legacy-images/netboot/ubuntu-installer/{{ ubuntu_arch }}/initrd.gz"
        dest: "{{ tftp_root }}/ubuntu/initrd.gz"
        mode: '0644'
        owner: root
        group: root
        timeout: 300
      when: initrd_download.failed | default(false)
      register: initrd_download_alt1
      failed_when: false

    - name: Try alternative URL (cdimage)
      get_url:
        url: "https://cdimage.ubuntu.com/netboot/{{ ubuntu_version }}/initrd.gz"
        dest: "{{ tftp_root }}/ubuntu/initrd.gz"
        mode: '0644'
        owner: root
        group: root
        timeout: 300
      when:
        - initrd_download.failed | default(false)
        - initrd_download_alt1.failed | default(false)
      register: initrd_download_alt2
      failed_when: false

    - name: Fail if all initrd download attempts failed
      fail:
        msg: |
          Failed to download Ubuntu initrd from all attempted URLs:
          - {{ ubuntu_netboot_base_url }}/initrd.gz
          - https://archive.ubuntu.com/ubuntu/dists/jammy/main/installer-{{ ubuntu_arch }}/current/legacy-images/netboot/ubuntu-installer/{{ ubuntu_arch }}/initrd.gz
          - https://cdimage.ubuntu.com/netboot/{{ ubuntu_version }}/initrd.gz
          
          Please check network connectivity or manually specify a working URL via ubuntu_netboot_base_url variable.
      when:
        - initrd_download.failed | default(false)
        - initrd_download_alt1.failed | default(false)
        - initrd_download_alt2.failed | default(false)
  when: not ubuntu_files_exist

# ============================================================================
# VERIFICATION
# ============================================================================
- name: Verify downloaded files
  stat:
    path: "{{ tftp_root }}/ubuntu/{{ item }}"
  register: ubuntu_files_verify
  loop:
    - vmlinuz
    - initrd.gz
  changed_when: false

- name: Display status
  debug:
    msg:
      - "Ubuntu netboot files status:"
      - "  vmlinuz: {{ 'EXISTS' if ubuntu_files_verify.results[0].stat.exists else 'MISSING' }}"
      - "  initrd.gz: {{ 'EXISTS' if ubuntu_files_verify.results[1].stat.exists else 'MISSING' }}"
      - "  Location: {{ tftp_root }}/ubuntu/"
      - "  Source: {{ ubuntu_netboot_base_url }}"

