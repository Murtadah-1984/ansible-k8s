---
# Swap Disabling Configuration
# Disables swap for Kubernetes compatibility

# ============================================================================
# SWAP DISABLING (Kubernetes requirement)
# ============================================================================
- name: Disable swap immediately
  command: swapoff -a
  changed_when: false
  failed_when: false

- name: Backup /etc/fstab before modification
  copy:
    src: /etc/fstab
    dest: /etc/fstab.backup
    remote_src: true
  failed_when: false
  changed_when: false

- name: Comment out swap entries in /etc/fstab
  replace:
    path: /etc/fstab
    regexp: '^([^#].*swap.*)$'
    replace: '# \1'
  failed_when: false

- name: Ensure swap.target.d override directory exists
  file:
    path: /etc/systemd/system/swap.target.d
    state: directory
    mode: '0755'
    owner: root
    group: root

- name: Create swap.target override to disable swap
  copy:
    dest: /etc/systemd/system/swap.target.d/override.conf
    content: |
      [Unit]
      ConditionPathExists=
      [Install]
      WantedBy=
    mode: '0644'
    owner: root
    group: root

- name: Mask swap.target
  systemd:
    name: swap.target
    masked: true
  failed_when: false

- name: Check for systemd-swap service
  stat:
    path: "{{ item }}"
  loop:
    - /lib/systemd/system/systemd-swap.service
    - /usr/lib/systemd/system/systemd-swap.service
  register: systemd_swap_service
  failed_when: false

- name: Stop and disable systemd-swap if present
  systemd:
    name: systemd-swap
    enabled: false
    state: stopped
  when: systemd_swap_service.results | selectattr('stat.exists') | list | length > 0
  failed_when: false

- name: Create systemd-swap override if service exists
  copy:
    dest: /etc/systemd/system/systemd-swap.service.d/override.conf
    content: |
      [Unit]
      ConditionPathExists=
      [Install]
      WantedBy=
    mode: '0644'
    owner: root
    group: root
  when: systemd_swap_service.results | selectattr('stat.exists') | list | length > 0

- name: Verify swap is disabled
  command: swapon --show
  register: swap_status
  changed_when: false
  failed_when: false

- name: Display swap status
  debug:
    msg: "{{ 'WARNING: Some swap devices are still active' if swap_status.stdout else 'SUCCESS: All swap devices disabled' }}"
  when: swap_status.stdout

