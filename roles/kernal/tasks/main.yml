---
# Kernel Configuration Role - Main Entry Point
# Orchestrates kernel configuration for Kubernetes

# ============================================================================
# KERNEL MODULES
# ============================================================================
- name: Configure kernel modules
  include_tasks: modules.yml

# ============================================================================
# SYSCTL PARAMETERS
# ============================================================================
- name: Configure sysctl parameters
  include_tasks: sysctl.yml

# ============================================================================
# SWAP DISABLING
# ============================================================================
- name: Disable swap
  include_tasks: swap.yml
  modprobe:
    name: "{{ item }}"
    state: present
  loop:
    - overlay
    - br_netfilter
  failed_when: false

- name: Configure kernel modules to load on boot
  copy:
    dest: /etc/modules-load.d/k8s.conf
    content: |
      # Kernel modules required for Kubernetes
      overlay
      br_netfilter
    mode: '0644'
    owner: root
    group: root

# ============================================================================
# SYSCTL PARAMETERS FOR KUBERNETES
# ============================================================================
- name: Configure sysctl parameters for Kubernetes
  copy:
    dest: /etc/sysctl.d/k8s-kernel.conf
    content: |
      # sysctl params required by Kubernetes setup
      net.bridge.bridge-nf-call-iptables  = 1
      net.bridge.bridge-nf-call-ip6tables = 1
      net.ipv4.ip_forward                 = 1
    mode: '0644'
    owner: root
    group: root

- name: Apply sysctl parameters
  command: sysctl --system
  changed_when: true
  failed_when: false

# ============================================================================
# SWAP DISABLING (Kubernetes requirement)
# ============================================================================
- name: Disable swap immediately
  command: swapoff -a
  changed_when: false
  failed_when: false

- name: Comment out swap entries in /etc/fstab
  replace:
    path: /etc/fstab
    regexp: '^([^#].*swap.*)$'
    replace: '# \1'
  backup: true
  failed_when: false

- name: Ensure swap.target.d override directory exists
  file:
    path: /etc/systemd/system/swap.target.d
    state: directory
    mode: '0755'
    owner: root
    group: root

- name: Create swap.target override to disable swap
  copy:
    dest: /etc/systemd/system/swap.target.d/override.conf
    content: |
      [Unit]
      ConditionPathExists=
      [Install]
      WantedBy=
    mode: '0644'
    owner: root
    group: root

- name: Mask swap.target
  systemd:
    name: swap.target
    masked: true
  failed_when: false

- name: Check for systemd-swap service
  stat:
    path: "{{ item }}"
  loop:
    - /lib/systemd/system/systemd-swap.service
    - /usr/lib/systemd/system/systemd-swap.service
  register: systemd_swap_service
  failed_when: false

- name: Stop and disable systemd-swap if present
  systemd:
    name: systemd-swap
    enabled: false
    state: stopped
  when: systemd_swap_service.results | selectattr('stat.exists') | list | length > 0
  failed_when: false

- name: Create systemd-swap override if service exists
  copy:
    dest: /etc/systemd/system/systemd-swap.service.d/override.conf
    content: |
      [Unit]
      ConditionPathExists=
      [Install]
      WantedBy=
    mode: '0644'
    owner: root
    group: root
  when: systemd_swap_service.results | selectattr('stat.exists') | list | length > 0

- name: Verify swap is disabled
  command: swapon --show
  register: swap_status
  changed_when: false
  failed_when: false

- name: Display swap status
  debug:
    msg: "{{ 'WARNING: Some swap devices are still active' if swap_status.stdout else 'SUCCESS: All swap devices disabled' }}"
  when: swap_status.stdout
