---
# Monitoring Role - Main Entry Point
# Orchestrates monitoring components installation and configuration

# ============================================================================
# PREREQUISITE CHECKS
# ============================================================================
- name: Verify systemd is available
  assert:
    that:
      - ansible_facts.get('service_mgr') == 'systemd'
    fail_msg: "This role requires systemd"
    success_msg: "Systemd detected"

# ============================================================================
# JOURNALD CONFIGURATION
# ============================================================================
- name: Configure journald
  include_tasks: journald.yml

# ============================================================================
# LOGROTATE CONFIGURATION
# ============================================================================
- name: Configure logrotate
  include_tasks: logrotate.yml

# ============================================================================
# CHRONY TIME SYNCHRONIZATION
# ============================================================================
- name: Configure chrony
  include_tasks: chrony.yml

# ============================================================================
# NODE EXPORTER
# ============================================================================
- name: Install and configure node_exporter
  include_tasks: node_exporter.yml

# ============================================================================
# FLUENT BIT
# ============================================================================
- name: Install and configure Fluent Bit
  include_tasks: fluent_bit.yml
- name: Configure journald for monitoring (upgrade-safe drop-in)
  blockinfile:
    path: /etc/systemd/journald.conf.d/99-k8s.conf
    marker: "# {mark} ANSIBLE MANAGED BLOCK - journald configuration"
    block: |
      [Journal]
      # Storage mode: auto, persistent, volatile, none
      Storage=auto
      
      # Maximum disk space for journal files
      SystemMaxUse={{ journald_system_max_use }}
      RuntimeMaxUse={{ journald_runtime_max_use }}
      
      # Compress old journal files
      Compress=yes
      
      # Sync interval (write to disk)
      SyncIntervalSec=5m
      
      # Rate limiting to prevent log spam
      RateLimitInterval=30s
      RateLimitBurst=5000
      
      # Maximum number of journal files to keep
      MaxRetentionSec={{ journald_max_retention_sec }}
      
      # Forward to syslog
      ForwardToSyslog=yes
    create: true
    mode: '0644'
    owner: root
    group: root
  when: journald_enabled | default(true)
  notify: restart systemd-journald

- name: Ensure journald drop-in directory exists
  file:
    path: /etc/systemd/journald.conf.d
    state: directory
    mode: '0755'
    owner: root
    group: root
  when: journald_enabled | default(true)

# ============================================================================
# LOGROTATE CONFIGURATION
# ============================================================================
- name: Configure logrotate for Kubernetes nodes
  copy:
    dest: /etc/logrotate.d/k8s-node
    content: |
      /var/log/syslog
      /var/log/kern.log
      /var/log/auth.log
      {
          rotate 7
          daily
          compress
          delaycompress
          missingok
          notifempty
          create 0644 root root
      }
    mode: '0644'
    owner: root
    group: root
  when: logrotate_enabled | default(true)

# ============================================================================
# CHRONY (TIME SYNCHRONIZATION)
# ============================================================================
- name: Install chrony package
  apt:
    name: chrony
    state: present
    update_cache: true
  when: chrony_enabled | default(true)

- name: Configure chrony
  template:
    src: chrony.conf.j2
    dest: /etc/chrony/chrony.conf
    owner: root
    group: root
    mode: '0644'
  when: chrony_enabled | default(true)
  notify: restart chrony

- name: Ensure chrony configuration directory exists
  file:
    path: /etc/chrony
    state: directory
    mode: '0755'
    owner: root
    group: root
  when: chrony_enabled | default(true)

- name: Enable and start chrony service
  systemd:
    name: chrony
    enabled: true
    state: started
    daemon_reload: true
  when: chrony_enabled | default(true)

# ============================================================================
# NODE EXPORTER (PROMETHEUS METRICS)
# ============================================================================
- name: Check if node_exporter user exists
  getent:
    database: passwd
    key: node_exporter
  register: node_exporter_user
  failed_when: false
  changed_when: false
  when: node_exporter_enabled | default(true)

- name: Create node_exporter user
  user:
    name: node_exporter
    system: true
    shell: /usr/sbin/nologin
    home: /nonexistent
    create_home: false
  when:
    - node_exporter_enabled | default(true)
    - node_exporter_user.ansible_facts.getent_passwd.node_exporter is not defined

- name: Check if node_exporter binary exists
  stat:
    path: /usr/local/bin/node_exporter
  register: node_exporter_binary
  when: node_exporter_enabled | default(true)

- name: Download node_exporter
  get_url:
    url: "https://github.com/prometheus/node_exporter/releases/download/v{{ node_exporter_version }}/node_exporter-{{ node_exporter_version }}.linux-amd64.tar.gz"
    dest: /tmp/node_exporter-{{ node_exporter_version }}.linux-amd64.tar.gz
    mode: '0644'
  when:
    - node_exporter_enabled | default(true)
    - not node_exporter_binary.stat.exists

- name: Extract node_exporter
  unarchive:
    src: /tmp/node_exporter-{{ node_exporter_version }}.linux-amd64.tar.gz
    dest: /tmp
    remote_src: true
  when:
    - node_exporter_enabled | default(true)
    - not node_exporter_binary.stat.exists

- name: Install node_exporter binary
  copy:
    src: /tmp/node_exporter-{{ node_exporter_version }}.linux-amd64/node_exporter
    dest: /usr/local/bin/node_exporter
    mode: '0755'
    owner: node_exporter
    group: node_exporter
    remote_src: true
  when:
    - node_exporter_enabled | default(true)
    - not node_exporter_binary.stat.exists
  notify: restart node_exporter

- name: Clean up node_exporter temporary files
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/node_exporter-{{ node_exporter_version }}.linux-amd64.tar.gz
    - /tmp/node_exporter-{{ node_exporter_version }}.linux-amd64
  when:
    - node_exporter_enabled | default(true)
    - not node_exporter_binary.stat.exists

- name: Configure node_exporter systemd service
  template:
    src: node_exporter.service.j2
    dest: /etc/systemd/system/node_exporter.service
    mode: '0644'
    owner: root
    group: root
  when: node_exporter_enabled | default(true)
  notify: restart node_exporter

- name: Enable and start node_exporter service
  systemd:
    name: node_exporter
    enabled: true
    state: started
    daemon_reload: true
  when: node_exporter_enabled | default(true)

# ============================================================================
# FLUENT BIT (LOG SHIPPING)
# ============================================================================
- name: Clean up old Fluent Bit repository files
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/apt/sources.list.d/fluentbit.list
    - /etc/apt/sources.list.d/fluent-bit.list
  failed_when: false
  when: fluent_bit_enabled | default(true)

- name: Install Fluent Bit prerequisites
  apt:
    name:
      - gpg
      - lsb-release
    state: present
    update_cache: false
  when:
    - fluent_bit_enabled | default(true)
    - not fluent_bit_repo_configured | default(false)

- name: Get OS codename for Fluent Bit repository
  set_fact:
    os_codename: "{{ ansible_facts.get('lsb', {}).get('codename', 'jammy') | default('jammy') }}"
  when:
    - fluent_bit_enabled | default(true)
    - not fluent_bit_repo_stat.stat.exists

- name: Detect OS type for Fluent Bit repository
  set_fact:
    repo_path: "{{ 'ubuntu' if ansible_facts.get('distribution') == 'Ubuntu' else 'debian' }}"
  when:
    - fluent_bit_enabled | default(true)
    - not fluent_bit_repo_stat.stat.exists

- name: Download Fluent Bit GPG key
  get_url:
    url: https://packages.fluentbit.io/fluentbit.key
    dest: /tmp/fluentbit.key
    mode: '0644'
  when:
    - fluent_bit_enabled | default(true)
    - not fluent_bit_repo_stat.stat.exists

- name: Add Fluent Bit GPG key to keyring
  command: gpg --dearmor < /tmp/fluentbit.key > /usr/share/keyrings/fluentbit-keyring.gpg
  args:
    creates: /usr/share/keyrings/fluentbit-keyring.gpg
  when:
    - fluent_bit_enabled | default(true)
    - not fluent_bit_repo_stat.stat.exists

- name: Create Fluent Bit repository file
  copy:
    dest: /etc/apt/sources.list.d/fluent-bit.list
    content: "deb [signed-by=/usr/share/keyrings/fluentbit-keyring.gpg] https://packages.fluentbit.io/{{ repo_path }}/{{ os_codename }} {{ os_codename }} main\n"
    mode: '0644'
    owner: root
    group: root
  when:
    - fluent_bit_enabled | default(true)
    - not fluent_bit_repo_stat.stat.exists

- name: Clean up Fluent Bit temporary key file
  file:
    path: /tmp/fluentbit.key
    state: absent
  when: fluent_bit_enabled | default(true)

- name: Update APT cache for Fluent Bit
  apt:
    update_cache: true
    cache_valid_time: 3600
  when:
    - fluent_bit_enabled | default(true)
    - not fluent_bit_repo_stat.stat.exists

- name: Install Fluent Bit package
  apt:
    name: fluent-bit
    state: present
    update_cache: false
  when: fluent_bit_enabled | default(true)

- name: Find fluent-bit binary location
  find:
    paths:
      - /usr/bin
      - /opt/fluent-bit/bin
      - /usr/local/bin
    patterns:
      - fluent-bit
    file_type: file
  register: fluent_bit_binary
  when: fluent_bit_enabled | default(true)

- name: Create symlink for fluent-bit if needed
  file:
    src: "{{ fluent_bit_binary.files[0].path if fluent_bit_binary.files | length > 0 else '/opt/fluent-bit/bin/fluent-bit' }}"
    dest: /usr/bin/fluent-bit
    state: link
  when:
    - fluent_bit_enabled | default(true)
    - fluent_bit_binary.files | length > 0
    - fluent_bit_binary.files[0].path != '/usr/bin/fluent-bit'

- name: Set fluent_bit_bin fact
  set_fact:
    fluent_bit_bin: "{{ fluent_bit_binary.files[0].path if fluent_bit_binary.files | length > 0 else '/usr/bin/fluent-bit' }}"
  when: fluent_bit_enabled | default(true)

- name: Configure Fluent Bit
  template:
    src: fluent-bit.conf.j2
    dest: /etc/fluent-bit/fluent-bit.conf
    owner: root
    group: root
    mode: '0644'
  when: fluent_bit_enabled | default(true)
  notify: restart fluent-bit

- name: Configure Fluent Bit parsers
  copy:
    dest: /etc/fluent-bit/parsers.conf
    content: |
      [PARSER]
          Name        docker
          Format      json
          Time_Key    time
          Time_Format %Y-%m-%dT%H:%M:%S.%L
    mode: '0644'
    owner: root
    group: root
  when: fluent_bit_enabled | default(true)
  notify: restart fluent-bit

- name: Ensure Fluent Bit configuration directory exists
  file:
    path: /etc/fluent-bit
    state: directory
    mode: '0755'
    owner: root
    group: root
  when: fluent_bit_enabled | default(true)

- name: Configure Fluent Bit systemd service
  template:
    src: fluent-bit.service.j2
    dest: /etc/systemd/system/fluent-bit.service
    mode: '0644'
    owner: root
    group: root
  when: fluent_bit_enabled | default(true)
  notify: restart fluent-bit

- name: Enable and start Fluent Bit service
  systemd:
    name: fluent-bit
    enabled: true
    state: started
    daemon_reload: true
  when: fluent_bit_enabled | default(true)

