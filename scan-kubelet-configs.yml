---
- name: Scan Kubelet Configurations for Misconfigurations
  hosts: k8s_nodes
  become: true
  gather_facts: true

  vars:
    kubelet_config_path: /var/lib/kubelet/config.yaml
    check_duplicates: true
    check_yaml_syntax: true
    check_permissions: true

  tasks:
    - name: Check if kubelet config file exists
      stat:
        path: "{{ kubelet_config_path }}"
      register: kubelet_config_stat
      failed_when: false

    - name: Display scan header
      debug:
        msg: "=== Scanning kubelet config on {{ inventory_hostname }} ==="
      when: kubelet_config_stat.stat.exists

    - name: Fail if kubelet config file does not exist
      fail:
        msg: "Kubelet config file not found at {{ kubelet_config_path }}"
      when: not kubelet_config_stat.stat.exists

    - name: Read kubelet config file
      slurp:
        src: "{{ kubelet_config_path }}"
      register: kubelet_config_content
      when: kubelet_config_stat.stat.exists

    - name: Check file permissions and ownership
      stat:
        path: "{{ kubelet_config_path }}"
      register: kubelet_config_perms
      when: check_permissions | default(true)

    - name: Report permission issues
      debug:
        msg:
          - "PERMISSION CHECK:"
          - "  Path: {{ kubelet_config_path }}"
          - "  Mode: {{ '%04o' | format(kubelet_config_perms.stat.mode | int) }}"
          - "  Owner: {{ kubelet_config_perms.stat.pw_name }}"
          - "  Group: {{ kubelet_config_perms.stat.gr_name }}"
          - "  Expected Mode: 0600"
          - "  Expected Owner: root"
          - "  Expected Group: root"
          - "  Status: {{ 'PASS' if (kubelet_config_perms.stat.mode | int) == 33152 and kubelet_config_perms.stat.pw_name == 'root' and kubelet_config_perms.stat.gr_name == 'root' else 'FAIL' }}"
      when: check_permissions | default(true)

    - name: Validate YAML syntax
      command: python3 -c "import yaml; yaml.safe_load(open('{{ kubelet_config_path }}'))"
      register: yaml_validation
      changed_when: false
      failed_when: false
      when: check_yaml_syntax | default(true)

    - name: Report YAML syntax errors
      debug:
        msg:
          - "YAML SYNTAX CHECK:"
          - "  Status: {{ 'FAIL' if yaml_validation.rc != 0 else 'PASS' }}"
          - "  Error: {{ yaml_validation.stderr if yaml_validation.rc != 0 else 'No errors' }}"
      when: check_yaml_syntax | default(true)

    - name: Extract config content for analysis
      set_fact:
        config_content: "{{ kubelet_config_content.content | b64decode }}"
      when: kubelet_config_stat.stat.exists

    - name: Find duplicate podPidsLimit entries
      shell: |
        grep -n "^podPidsLimit:" "{{ kubelet_config_path }}" || echo ""
      register: podpidslimit_lines
      changed_when: false
      failed_when: false
      when: check_duplicates | default(true)

    - name: Count podPidsLimit occurrences
      set_fact:
        podpidslimit_count: "{{ podpidslimit_lines.stdout_lines | select('match', '.*') | list | length }}"
      when: check_duplicates | default(true)

    - name: Report duplicate podPidsLimit entries
      debug:
        msg:
          - "DUPLICATE CHECK - podPidsLimit:"
          - "  Status: {{ 'FAIL - DUPLICATE FOUND' if podpidslimit_count | int > 1 else 'PASS' }}"
          - "  Occurrences: {{ podpidslimit_count }}"
          - "  Lines: {{ podpidslimit_lines.stdout_lines | join(', ') if podpidslimit_lines.stdout_lines | length > 0 else 'Not found' }}"
      when: check_duplicates | default(true)

    - name: Find all duplicate keys in YAML
      shell: |
        # Extract all top-level keys (simple pattern matching)
        grep -E "^[a-zA-Z][a-zA-Z0-9]*:" "{{ kubelet_config_path }}" | \
        sed 's/:.*//' | \
        sort | \
        uniq -d || echo ""
      register: duplicate_keys
      changed_when: false
      failed_when: false
      when: check_duplicates | default(true)

    - name: Report all duplicate keys
      debug:
        msg:
          - "DUPLICATE CHECK - All Keys:"
          - "  Status: {{ 'FAIL - DUPLICATES FOUND' if duplicate_keys.stdout | length > 0 else 'PASS' }}"
          - "  Duplicate keys: {{ duplicate_keys.stdout_lines | join(', ') if duplicate_keys.stdout_lines | length > 0 else 'None' }}"
      when: check_duplicates | default(true) and duplicate_keys.stdout is defined

    - name: Extract podPidsLimit values
      shell: |
        grep "^podPidsLimit:" "{{ kubelet_config_path }}" | sed 's/.*podPidsLimit:[[:space:]]*//' || echo ""
      register: podpidslimit_values
      changed_when: false
      failed_when: false
      when: check_duplicates | default(true) and podpidslimit_count | int > 1

    - name: Report conflicting podPidsLimit values
      debug:
        msg:
          - "CONFLICT CHECK - podPidsLimit values:"
          - "  Values found: {{ podpidslimit_values.stdout_lines | join(', ') }}"
          - "  Status: {{ 'FAIL - CONFLICTING VALUES' if podpidslimit_values.stdout_lines | unique | list | length > 1 else 'PASS - Same values' }}"
      when: check_duplicates | default(true) and podpidslimit_count | int > 1

    - name: Parse YAML and check for duplicate keys (advanced check)
      shell: |
        python3 << 'EOF'
        import yaml
        import sys
        
        try:
            with open('{{ kubelet_config_path }}', 'r') as f:
                # Use safe_load to avoid code execution
                config = yaml.safe_load(f)
            
            # Check for duplicate keys by parsing raw YAML
            with open('{{ kubelet_config_path }}', 'r') as f:
                lines = f.readlines()
            
            keys_seen = {}
            duplicates = []
            
            for i, line in enumerate(lines, 1):
                stripped = line.strip()
                # Match top-level keys (not indented)
                if stripped and not stripped.startswith('#') and ':' in stripped:
                    if not line.startswith(' ') and not line.startswith('\t'):
                        key = stripped.split(':')[0].strip()
                        if key in keys_seen:
                            duplicates.append(f"{key} (lines {keys_seen[key]} and {i})")
                        else:
                            keys_seen[key] = i
            
            if duplicates:
                print("DUPLICATES:", ",".join(duplicates))
            else:
                print("NO_DUPLICATES")
        except Exception as e:
            print(f"ERROR: {str(e)}", file=sys.stderr)
            sys.exit(1)
        EOF
      register: yaml_duplicate_check
      changed_when: false
      failed_when: false
      when: check_duplicates | default(true)

    - name: Report YAML duplicate check results
      debug:
        msg:
          - "ADVANCED DUPLICATE CHECK (YAML parsing):"
          - "  Result: {{ yaml_duplicate_check.stdout }}"
          - "  Status: {{ 'FAIL' if 'DUPLICATES:' in yaml_duplicate_check.stdout else 'PASS' if 'NO_DUPLICATES' in yaml_duplicate_check.stdout else 'ERROR' }}"
      when: check_duplicates | default(true) and yaml_duplicate_check.stdout is defined

    - name: Generate summary report
      set_fact:
        scan_summary:
          hostname: "{{ inventory_hostname }}"
          config_exists: "{{ kubelet_config_stat.stat.exists }}"
          yaml_valid: "{{ 'PASS' if yaml_validation.rc == 0 else 'FAIL' }}"
          permissions_ok: "{{ 'PASS' if (kubelet_config_perms.stat.mode | int) == 33152 and kubelet_config_perms.stat.pw_name == 'root' and kubelet_config_perms.stat.gr_name == 'root' else 'FAIL' }}"
          podpidslimit_duplicate: "{{ 'FAIL' if podpidslimit_count | int > 1 else 'PASS' }}"
          duplicate_keys_found: "{{ 'FAIL' if duplicate_keys.stdout | length > 0 else 'PASS' }}"
          yaml_duplicates: "{{ 'FAIL' if 'DUPLICATES:' in yaml_duplicate_check.stdout else 'PASS' if 'NO_DUPLICATES' in yaml_duplicate_check.stdout else 'UNKNOWN' }}"

    - name: Display summary for {{ inventory_hostname }}
      debug:
        msg:
          - ""
          - "=== SCAN SUMMARY FOR {{ inventory_hostname }} ==="
          - "Config file exists: {{ scan_summary.config_exists }}"
          - "YAML syntax valid: {{ scan_summary.yaml_valid }}"
          - "Permissions correct: {{ scan_summary.permissions_ok }}"
          - "podPidsLimit duplicate: {{ scan_summary.podpidslimit_duplicate }}"
          - "Duplicate keys found: {{ scan_summary.duplicate_keys_found }}"
          - "YAML duplicate check: {{ scan_summary.yaml_duplicates }}"
          - ""

  post_tasks:
    - name: Display final summary report header
      debug:
        msg:
          - ""
          - "=========================================="
          - "SCAN COMPLETED - Review output above"
          - "=========================================="
          - ""
          - "To see issues, look for nodes with:"
          - "  - 'FAIL' status in any check"
          - "  - 'DUPLICATE FOUND' messages"
          - "  - 'CONFLICTING VALUES' messages"
          - ""
      run_once: true
      delegate_to: localhost

